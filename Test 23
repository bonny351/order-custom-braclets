<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactics & Treats ‚Äì Admin Panel</title>

<style>
body{
  font-family:"Poppins",sans-serif;
  background:#111;
  color:white;
  margin:0;
  padding:20px;
}
h1,h2{
  text-align:center;
  color:#ff0000;
}

/* header */
header{
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(90deg,#7a0c0c,#000);
  padding:15px;
  border-radius:10px;
  margin-bottom:20px;
  box-shadow:0 0 12px rgba(255,0,0,0.4);
}

/* tabs */
.tabs,.subTabs{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:15px;
}
.tab,.subTab{
  padding:10px 20px;
  background:#222;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  transition:0.2s;
}
.tab.active,.subTab.active{
  background:#ff0000;
  box-shadow:0 0 8px red;
}

/* table */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  padding:10px;
  border:1px solid #ff0000;
  text-align:center;
}
tr:nth-child(even){background:#222;}

/* status dropdown */
.statusSelect{
  padding:6px;
  background:#222;
  color:white;
  border-radius:6px;
  border:1px solid #ff0000;
}

/* row colors */
.paidRow{background:rgba(0,255,0,0.25)!important;}
.pendingRow{background:rgba(255,255,0,0.25)!important;}
.unpaidRow{background:rgba(255,0,0,0.25)!important;}
.lateRow{outline:2px solid orange;}

/* Action buttons */
.actionBar{
  display:flex;
  justify-content:center;
  gap:10px;
  margin:15px 0;
}
.actionBar button{
  background:#ff0000;
  border:none;
  padding:10px 15px;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
.actionBar button:hover{
  background:#cc0000;
  box-shadow:0 0 10px red;
}

/* summary bar */
.summaryBar{
  background:#222;
  padding:10px;
  border-radius:10px;
  text-align:center;
  margin-top:10px;
  font-weight:bold;
  color:#ffb347;
}

/* DETAILS POPUP */
#detailsModal{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.8);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:2000;
}
#detailsBox{
  background:#181818;
  padding:20px;
  border-radius:12px;
  width:90%;
  max-width:500px;
  box-shadow:0 0 15px red;
}
.closeBtn{
  float:right;
  cursor:pointer;
  font-size:20px;
  color:#ff4444;
}

/* PRINT RECEIPT WINDOW */
#printArea{
  display:none;
  background:white;
  color:black;
  padding:20px;
}

/* DASHBOARD */
#dashboard{
  background:#181818;
  border-radius:12px;
  padding:20px;
  margin-top:20px;
  box-shadow:0 0 10px rgba(255,0,0,0.3);
  display:none;
}

.chartBox{
  margin:20px auto;
  width:90%;
  max-width:400px;
  background:#222;
  padding:15px;
  border-radius:10px;
}
</style>
</head>

<body>

<header><h1>Tactics & Treats Admin Panel</h1></header>

<div class="tabs" id="mainTabs"></div>
<div class="subTabs" id="subTabs"></div>

<section>
  <h2 id="tableTitle"></h2>

  <input type="text" id="searchInput"
   placeholder="üîç Search..."
   style="width:90%;max-width:400px;margin:auto;display:block;">

  <div class="actionBar">
    <button id="deleteSelected">üóë Delete Selected</button>
    <button id="copySelected">üìã Copy Selected</button>
    <button id="exportCSV">üì• Export CSV</button>
    <button id="sortUnpaid">‚¨Ü Unpaid First</button>
    <button id="openDashboard">üìä Dashboard</button>
  </div>

  <p id="tableMsg" style="text-align:center;"></p>

  <table id="dynamicTable"></table>

  <div class="summaryBar" id="summaryBar"></div>
</section>

<!-- DETAILS POPUP -->
<div id="detailsModal">
  <div id="detailsBox">
    <span class="closeBtn" onclick="closeDetails()">‚úñ</span>
    <h2>Order Details</h2>
    <div id="detailsContent"></div>
    <br>
    <button onclick="printOrder()">üñ® Print This Order</button>
    <button onclick="sendSMS()">üì≤ Text Customer</button>
  </div>
</div>

<!-- PRINT AREA -->
<div id="printArea"></div>

<!-- DASHBOARD -->
<div id="dashboard">
  <h2>üìä Analytics Dashboard</h2>
  <div id="dashTotals"></div>

  <div class="chartBox">
    <canvas id="chartStatus"></canvas>
  </div>

  <div class="chartBox">
    <canvas id="chartProfit"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore,collection,getDocs,doc,setDoc,deleteDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* TAB SYSTEM */
const collections={
  "Products":["products","products_bracelets","products_cookies","products_spirit"],
  "Orders":["braceletOrders","cookieOrders","spiritOrders"],
  "Users":["users"],
  "Settings":["siteSettings"]
};

const mainTabs=document.getElementById("mainTabs");
const subTabs=document.getElementById("subTabs");
const table=document.getElementById("dynamicTable");
const title=document.getElementById("tableTitle");
const msg=document.getElementById("tableMsg");
const summaryBar=document.getElementById("summaryBar");
const dashboard=document.getElementById("dashboard");

let currentCollection="";
let currentOrders=[];

/* MAIN TABS */
Object.keys(collections).forEach(cat=>{
  const t=document.createElement("div");
  t.className="tab";
  t.textContent=cat;
  t.onclick=()=>{
    [...mainTabs.children].forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    loadSubTabs(cat);
  };
  mainTabs.appendChild(t);
});
mainTabs.children[0].click();

/* SUB TABS */
function loadSubTabs(cat){
  subTabs.innerHTML="";
  collections[cat].forEach(sub=>{
    const st=document.createElement("div");
    st.className="subTab";
    st.textContent=sub;
    st.onclick=()=>{
      [...subTabs.children].forEach(x=>x.classList.remove("active"));
      st.classList.add("active");
      loadTable(sub);
    };
    subTabs.appendChild(st);
  });
  subTabs.children[0].click();
}

/* COLOR ROWS */
function colorRow(row,status,createdAt){
  row.classList.remove("paidRow","pendingRow","unpaidRow","lateRow");

  if(status==="Paid in Cash"||status==="Paid by Card") row.classList.add("paidRow");
  else if(status==="Pending") row.classList.add("pendingRow");
  else if(status==="Unpaid") row.classList.add("unpaidRow");

  // LATE ORDER (older than 5 days)
  if(createdAt){
    const age=(Date.now()-new Date(createdAt))/86400000;
    if(age>5 && status!=="Paid in Cash" && status!=="Paid by Card"){
      row.classList.add("lateRow");
    }
  }
}

/* STATUS DROPDOWN */
function statusDropdown(row,data,id){
  const select=document.createElement("select");
  select.className="statusSelect";

  ["Paid in Cash","Paid by Card","Unpaid","Pending"].forEach(s=>{
    const opt=new Option(s,s);
    if(data.status===s) opt.selected=true;
    select.add(opt);
  });

  colorRow(row,data.status,data.createdAt);

  select.onchange=async()=>{
    data.status=select.value;
    colorRow(row,select.value);

    try{
      await setDoc(doc(db,currentCollection,id),data);
      msg.textContent="‚úî Status Updated";
    }catch{
      msg.textContent="‚ùå Failed to Update";
    }
  };

  return select;
}

/* LOAD TABLE */
async function loadTable(col){
  currentCollection=col;
  title.textContent=col;
  table.innerHTML="";
  currentOrders=[];

  const snap=await getDocs(collection(db,col));
  const docs=snap.docs;

  if(!docs.length){
    table.innerHTML="<tr><td>No Data</td></tr>";
    return;
  }

  /* Collect keys */
  const keys=new Set(["status"]);
  docs.forEach(d=>Object.keys(d.data()).forEach(k=>keys.add(k)));
  const keyList=[...keys];

  /* Header */
  const header=table.insertRow();
  header.insertCell().textContent="Select";
  header.insertCell().textContent="Status";
  header.insertCell().textContent="Details";
  keyList.forEach(k=>{
    const th=document.createElement("th");
    th.textContent=k;
    header.appendChild(th);
  });

  docs.forEach(docSnap=>{
    const data=docSnap.data();
    const row=table.insertRow();
    currentOrders.push({...data,id:docSnap.id});

    /* Checkbox */
    const cbCell=row.insertCell();
    cbCell.innerHTML=`<input type="checkbox" class="rowCB" data-id="${docSnap.id}">`;

    /* Status */
    const statusCell=row.insertCell();
    statusCell.appendChild(statusDropdown(row,data,docSnap.id));

    /* DETAILS BUTTON */
    const details=row.insertCell();
    details.innerHTML=`<button onclick="openDetails('${docSnap.id}')">üìÑ</button>`;

    /* DATA CELLS */
    keyList.forEach(k=>{
      const c=row.insertCell();
      c.textContent=data[k] ?? "";
      c.contentEditable=true;

      c.onblur=async()=>{
        const newVal=c.textContent.trim();
        data[k]=newVal;

        try{
          await setDoc(doc(db,col,docSnap.id),data);
          msg.textContent=`‚úî Updated ${k}`;
        }catch{
          msg.textContent="‚ùå Failed";
        }
      };
    });

    colorRow(row,data.status,data.createdAt);
  });

  updateSummary();
}

/* SUMMARY BAR */
function updateSummary(){
  const rows=[...table.rows].slice(1);

  let paid=0,unpaid=0,pending=0,totalProfit=0;

  rows.forEach(r=>{
    const st=r.cells[1].innerText.trim();
    const totalCell=r.cells[r.cells.length-1]?.innerText;

    const price=parseFloat(totalCell)||0;

    if(st.includes("Paid")){paid++; totalProfit+=price;}
    else if(st==="Pending") pending++;
    else if(st==="Unpaid") unpaid++;
  });

  summaryBar.innerHTML=
    `Total Orders: ${rows.length} | 
     Paid: ${paid} |
     Pending: ${pending} |
     Unpaid: ${unpaid} |
     Profit: $${totalProfit.toFixed(2)}`;
}

/* DELETE */
deleteSelected.onclick=async()=>{
  const selected=[...document.querySelectorAll(".rowCB:checked")];

  if(!selected.length)return alert("No rows selected.");
  if(!confirm("Delete selected orders?"))return;

  for(const cb of selected){
    await deleteDoc(doc(db,currentCollection,cb.dataset.id));
  }
  loadTable(currentCollection);
};

/* COPY */
copySelected.onclick=()=>{
  const rows=[...table.rows].slice(1);
  const selected=rows.filter(r=>r.querySelector(".rowCB").checked);

  const output=selected.map(r=>{
    const cells=[...r.cells].map(c=>c.innerText.trim());
    return cells;
  });

  navigator.clipboard.writeText(JSON.stringify(output,null,2));
  alert("Copied!");
};

/* CSV EXPORT */
exportCSV.onclick=()=>{

  let csv="";
  const rows=[...table.rows];

  rows.forEach(row=>{
    const cols=[...row.cells].map(c=>c.innerText.replace(/,/g,";"));
    csv+=cols.join(",")+"\n";
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);

  const a=document.createElement("a");
  a.href=url;
  a.download=currentCollection+".csv";
  a.click();
};

/* SORT UNPAID FIRST */
sortUnpaid.onclick=()=>{
  const rows=[...table.rows].slice(1);

  rows.sort((a,b)=>{
    const A=a.cells[1].innerText;
    const B=b.cells[1].innerText;
    const order={ "Unpaid":0, "Pending":1, "Paid in Cash":2, "Paid by Card":2 };
    return order[A]-order[B];
  });

  rows.forEach(r=>table.appendChild(r));
};

/* SEARCH */
searchInput.oninput=()=>{
  const t=searchInput.value.toLowerCase();
  [...table.rows].forEach((r,i)=>{
    if(i===0)return;
    r.style.display=r.innerText.toLowerCase().includes(t) ? "" : "none";
  });
};

/* DETAILS POPUP */
window.openDetails=(id)=>{
  const order=currentOrders.find(o=>o.id===id);
  const box=document.getElementById("detailsContent");

  let html="";
  Object.keys(order).forEach(k=>{
    html+=`<p><b>${k}:</b> ${order[k]}</p>`;
  });

  box.innerHTML=html;
  window.currentDetailOrder=order;

  document.getElementById("detailsModal").style.display="flex";
};

window.closeDetails=()=>{
  document.getElementById("detailsModal").style.display="none";
};

/* PRINT ORDER */
window.printOrder=()=>{
  const o=window.currentDetailOrder;

  let html="<h2>Tactics & Treats Order Receipt</h2>";
  Object.keys(o).forEach(k=>{
    html+=`<p><b>${k}:</b> ${o[k]}</p>`;
  });

  const printArea=document.getElementById("printArea");
  printArea.innerHTML=html;
  printArea.style.display="block";

  window.print();

  printArea.style.display="none";
};

/* SMS */
window.sendSMS=()=>{
  const o=window.currentDetailOrder;

  const number=o.phone||o.Phone||"";
  const msgText=encodeURIComponent("Hi! Your Tactics & Treats order update: " + o.status);

  window.location.href=`sms:${number}?body=${msgText}`;
};

/* DASHBOARD */
openDashboard.onclick=()=>{
  dashboard.style.display = dashboard.style.display==="none" ? "block" : "none";
  buildDashboard();
};

function buildDashboard(){
  const paid=currentOrders.filter(o=>o.status?.includes("Paid"));
  const unpaid=currentOrders.filter(o=>o.status==="Unpaid");
  const pending=currentOrders.filter(o=>o.status==="Pending");

  const profits=paid.map(o=>parseFloat(o.total)||0);

  document.getElementById("dashTotals").innerHTML=
    `<p>Total Orders: ${currentOrders.length}</p>
     <p>Paid: ${paid.length}</p>
     <p>Pending: ${pending.length}</p>
     <p>Unpaid: ${unpaid.length}</p>
     <p>Total Profit: $${profits.reduce((a,b)=>a+b,0).toFixed(2)}</p>`;

  new Chart(document.getElementById("chartStatus").getContext("2d"),{
    type:"pie",
    data:{
      labels:["Paid","Pending","Unpaid"],
      datasets:[{
        data:[paid.length,pending.length,unpaid.length],
        backgroundColor:["green","yellow","red"]
      }]
    }
  });

  new Chart(document.getElementById("chartProfit").getContext("2d"),{
    type:"bar",
    data:{
      labels:["Profit"],
      datasets:[{
        label:"Total Profit",
        data:[profits.reduce((a,b)=>a+b,0)],
        backgroundColor:"orange"
      }]
    }
  });
}

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactics & Treats – Admin Panel</title>

<style>
body {
  font-family: "Poppins", sans-serif;
  background:#111;
  color:white;
  margin:0;
  padding:20px;
}

h1,h2 { text-align:center; color:#ff0000; }

header {
  background:linear-gradient(90deg,#7a0c0c,#000);
  padding:15px;
  border-radius:10px;
  box-shadow:0 0 12px rgba(255,0,0,0.4);
  margin-bottom:15px;
}

.tabs {
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:15px;
}

.tab {
  padding:10px 20px;
  background:#222;
  border-radius:5px;
  cursor:pointer;
  font-weight:bold;
}

.tab.active {
  background:#ff0000;
  box-shadow:0 0 8px #ff0000;
}

.dashboard {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:12px;
  margin-bottom:15px;
}

.stat {
  background:#181818;
  padding:12px;
  border-radius:10px;
  box-shadow:0 0 10px rgba(255,0,0,.25);
  text-align:center;
}

.stat h3 { margin:0; color:#ffb347; }
.stat p { font-size:20px; margin:5px 0 0; }

section {
  background:#181818;
  padding:20px;
  border-radius:12px;
  box-shadow:0 0 12px rgba(255,0,0,0.2);
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

th,td {
  border:1px solid #ff0000;
  padding:8px;
  text-align:center;
}

tr:nth-child(even) { background:#222; }

select {
  background:#222;
  color:white;
  border:1px solid #ff0000;
  border-radius:5px;
}
</style>
</head>

<body>

<header><h1>Tactics & Treats Admin Panel</h1></header>

<div class="tabs">
  <div class="tab active" onclick="switchTab('orders')">Orders</div>
  <div class="tab" onclick="switchTab('products')">Products</div>
  <div class="tab" onclick="switchTab('audit')">Audit</div>
</div>

<!-- DASHBOARD -->
<div class="dashboard">
  <div class="stat"><h3>Today</h3><p id="todayCount">0</p></div>
  <div class="stat"><h3>This Week</h3><p id="weekCount">0</p></div>
  <div class="stat"><h3>Revenue</h3><p id="revenue">$0</p></div>
  <div class="stat"><h3>Top Product</h3><p id="topProduct">—</p></div>
</div>

<section>
  <h2 id="tableTitle">Orders</h2>
  <table id="table"></table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, setDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let mode="orders";
const table=document.getElementById("table");

/* TAB SWITCH */
window.switchTab = t=>{
  mode=t;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  event.target.classList.add("active");
  load();
};

/* DASHBOARD */
function updateDashboard(orders){
  const now=new Date();
  let today=0, week=0, revenue=0;
  const counts={};

  orders.forEach(o=>{
    const d=o.createdAt?.toDate?.()||new Date(o.createdAt);
    const diff=(now-d)/86400000;
    if(diff<1) today++;
    if(diff<7) week++;
    if(o.status!=="deleted"){
      revenue+= (o.price||0)*(o.qty||1);
      counts[o.productName]=(counts[o.productName]||0)+(o.qty||1);
    }
  });

  todayCount.textContent=today;
  weekCount.textContent=week;
  revenue.textContent="$"+revenue.toFixed(2);
  topProduct.textContent=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0]||"—";
}

/* AUDIT LOG */
async function logAudit(type, details){
  await addDoc(collection(db,"auditLog"),{
    type,
    details,
    at:new Date()
  });
}

/* LOAD TABLE */
async function load(){
  table.innerHTML="";
  document.getElementById("tableTitle").textContent=mode.toUpperCase();

  const snap=await getDocs(collection(db,mode==="audit"?"auditLog":mode));
  const rows=snap.docs.map(d=>({id:d.id,...d.data()}));

  if(mode==="orders") updateDashboard(rows);

  if(rows.length===0){
    table.innerHTML="<tr><td>No data</td></tr>";
    return;
  }

  const keys=new Set();
  rows.forEach(r=>Object.keys(r).forEach(k=>keys.add(k)));
  const cols=[...keys];

  const head=table.insertRow();
  cols.forEach(c=>head.insertCell().textContent=c);

  rows.forEach(r=>{
    const row=table.insertRow();
    cols.forEach(c=>{
      const cell=row.insertCell();
      cell.textContent=r[c]||"";
      if(mode!=="audit"){
        cell.contentEditable=true;
        cell.onblur=async()=>{
          const old=r[c];
          r[c]=cell.textContent;
          await setDoc(doc(db,mode,r.id),r);
          await logAudit("edit",{mode,id:r.id,field:c,from:old,to:r[c]});
        };
      }
    });
  });
}

load();
</script>
</body>
</html>


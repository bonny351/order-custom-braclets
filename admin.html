<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Admin Panel ‚Äì Tactics & Treats</title>
<style>
body { font-family:"Poppins",sans-serif; background:#111; color:white; margin:0; padding:20px; }
h1,h2 { text-align:center; color:#ff0000; margin-bottom:20px; }
section { background:#181818; padding:20px; border-radius:12px; box-shadow:0 0 12px rgba(255,0,0,0.2); margin-bottom:30px; transition:opacity 0.3s; }
.tabs, .subTabs { display:flex; justify-content:center; margin-bottom:15px; gap:10px; flex-wrap:wrap; }
.tab, .subTab { padding:10px 20px; cursor:pointer; border-radius:5px; background:#222; color:#fff; font-weight:bold; transition:0.2s; }
.tab.active, .subTab.active { background:#ff0000; color:#fff; box-shadow:0 0 8px #ff0000; }
.tab:hover, .subTab:hover { background:#ff4444; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { padding:10px; border:1px solid #ff0000; text-align:center; }
th { background:#222; color:#ffb347; position:sticky; top:0; z-index:1; }
tr:nth-child(even) { background:#222; }
tr:hover { background:#333; transition:0.2s; }
td:focus { outline:2px solid #ff0000; background:#222; }
#searchInput { width:100%; max-width:400px; margin:10px auto; display:block; padding:8px; border-radius:5px; border:none; font-size:14px; }
button { padding:8px 12px; margin:5px; background:#ff0000; color:white; font-weight:bold; border:none; border-radius:8px; cursor:pointer; transition:0.2s; }
button:hover { background:darkred; box-shadow:0 0 8px #ff0000; }
.message { color:#ffb347; font-weight:bold; text-align:center; margin-top:10px;}
.status-pending { color:#ffb347; font-weight:bold; }
.status-completed { color:#0f0; font-weight:bold; }
.status-cancelled { color:#f00; font-weight:bold; }
.recent-order { background:rgba(255,255,255,0.1) !important; }
.out-of-stock { background:rgba(255,0,0,0.2); font-weight:bold; }
.flex { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
select { padding:4px 6px; border-radius:5px; border:none; background:#222; color:white; }
input[type=number] { width:70px; }
label { cursor:pointer; margin-right:6px; }
#maintenanceOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
  background:#111; color:#ff0000; font-size:24px; display:flex; justify-content:center; align-items:center; z-index:9999; text-align:center;}
span.day { display:inline-block; padding:4px 8px; margin:2px; border-radius:4px; color:white; }
span.scheduled { background:red; }
span.unscheduled { background:#444; }
</style>
</head>
<body>

<h1>Full Admin Panel ‚Äì Tactics & Treats</h1>

<div class="tabs" id="mainTabs"></div>
<div class="subTabs" id="collectionTabs"></div>

<section id="tableSection">
<h2 id="tableTitle">Loading...</h2>
<input type="text" id="searchInput" placeholder="üîç Search...">
<p id="tableMsg" class="message"></p>
<table id="dynamicTable"></table>
<div id="actionButtons" class="flex"></div>

<hr style="border-color:#ff4444;">

<button id="toggleMaintenanceBtn">‚ö†Ô∏è Toggle Under Construction</button>
<p id="maintenanceMsg" class="message"></p>

<div id="maintenanceScheduleDiv" style="text-align:center; margin-top:10px;"></div>
<div id="maintenanceDaysDiv" style="text-align:center; margin-top:10px;"></div>
</section>

<div id="maintenanceOverlay">üõ†Ô∏è Site is currently under maintenance. Please check back later.</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ---------- Firebase ----------
const firebaseConfig = {
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- Utility: Convert Firestore timestamp ----------
function convertFirestoreTimestamp(ts) {
  if (ts && typeof ts === "object" && "seconds" in ts && "nanoseconds" in ts) {
    const ms = ts.seconds * 1000 + ts.nanoseconds / 1_000_000;
    return new Date(ms).toLocaleString();
  }
  return ts;
}

// ---------- Collections ----------
const allCollections = {
  "Products": ["products", "products_bracelets", "products_cookies", "products_spirit"],
  "Orders": ["braceletOrders", "cookieOrders", "spiritOrders"],
  "Users": ["users", "activityLogs"],
  "Settings": ["_meta", "metadata", "siteSettings", "adminSettings", "colors", "braceletColors"]
};

// ---------- DOM ----------
const mainTabsDiv = document.getElementById("mainTabs");
const collectionTabsDiv = document.getElementById("collectionTabs");
const tableTitle = document.getElementById("tableTitle");
const dynamicTable = document.getElementById("dynamicTable");
const searchInput = document.getElementById("searchInput");
const tableMsg = document.getElementById("tableMsg");
const actionButtonsDiv = document.getElementById("actionButtons");
const toggleBtn = document.getElementById("toggleMaintenanceBtn");
const maintenanceMsg = document.getElementById("maintenanceMsg");
const maintenanceScheduleDiv = document.getElementById("maintenanceScheduleDiv");
const maintenanceDaysDiv = document.getElementById("maintenanceDaysDiv");
const maintenanceOverlay = document.getElementById("maintenanceOverlay");

let currentCategory = "";
let currentCollection = "";
const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const dayCheckboxes = [];
const maintenanceDoc = doc(db,"siteSettings","maintenance");

// ---------- Admin page flag ----------
const isAdminPage = true; // overlay never shows

// ---------- Tabs ----------
Object.keys(allCollections).forEach(cat=>{
  const tab = document.createElement("div");
  tab.className="tab"; tab.textContent=cat;
  tab.addEventListener("click",()=>{
    currentCategory=cat;
    [...mainTabsDiv.children].forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    loadCollectionTabs();
  });
  mainTabsDiv.appendChild(tab);
});
mainTabsDiv.children[0].click();

// ---------- Sub-tabs ----------
function loadCollectionTabs(){
  collectionTabsDiv.innerHTML="";
  allCollections[currentCategory].forEach(coll=>{
    const subTab = document.createElement("div");
    subTab.className="subTab"; subTab.textContent=coll;
    subTab.addEventListener("click",()=>{
      currentCollection=coll;
      [...collectionTabsDiv.children].forEach(t=>t.classList.remove("active"));
      subTab.classList.add("active");
      loadTable();
    });
    collectionTabsDiv.appendChild(subTab);
  });
  collectionTabsDiv.children[0].click();
}

// ---------- Maintenance ----------
async function loadMaintenanceStatus(){
  try{
    const docSnap = await getDoc(maintenanceDoc);
    const data = docSnap.exists()?docSnap.data():{enabled:false, scheduledDays:[]};
    maintenanceMsg.textContent = data.enabled?"üõ†Ô∏è Site is UNDER CONSTRUCTION":"‚úÖ Site is LIVE";
    loadMaintenanceSchedule(data.scheduledDays||[]);
    displayScheduledDays(data.scheduledDays||[]);
    checkScheduledMaintenance(data);
  }catch(err){ console.error(err); maintenanceMsg.textContent="‚ùå Error"; }
}

function displayScheduledDays(scheduledDays){
  maintenanceDaysDiv.innerHTML="<strong>Scheduled Maintenance Days:</strong><br>";
  days.forEach((day,i)=>{
    const span = document.createElement("span");
    span.className = scheduledDays.includes(i) ? "day scheduled" : "day unscheduled";
    span.textContent = day;
    maintenanceDaysDiv.appendChild(span);
  });
}

function loadMaintenanceSchedule(scheduledDays){
  maintenanceScheduleDiv.innerHTML="<strong>Schedule Maintenance:</strong><br>";
  days.forEach((day,i)=>{
    const label=document.createElement("label");
    const cb=document.createElement("input"); cb.type="checkbox"; cb.value=i; cb.checked=scheduledDays.includes(i);
    cb.addEventListener("change", ()=> displayScheduledDays(dayCheckboxes.filter(cb=>cb.checked).map(cb=>parseInt(cb.value))));
    dayCheckboxes[i]=cb; label.appendChild(cb); label.appendChild(document.createTextNode(day)); maintenanceScheduleDiv.appendChild(label);
  });
  const saveBtn=document.createElement("button"); saveBtn.textContent="üíæ Save Schedule";
  saveBtn.addEventListener("click", saveSchedule);
  maintenanceScheduleDiv.appendChild(saveBtn);
}

async function saveSchedule(){
  const selectedDays = dayCheckboxes.filter(cb=>cb.checked).map(cb=>parseInt(cb.value));
  try{
    await setDoc(maintenanceDoc,{enabled:true, scheduledDays:selectedDays},{merge:true});
    alert("‚úÖ Maintenance schedule saved! Site is now UNDER CONSTRUCTION.");
    displayScheduledDays(selectedDays);
    loadMaintenanceStatus();
  }catch(err){ console.error(err); alert("‚ùå Error"); }
}

function checkScheduledMaintenance(data){
  const today = new Date().getDay();
  const underMaintenance = data.enabled || (data.scheduledDays && data.scheduledDays.includes(today));
  maintenanceMsg.textContent = underMaintenance ? "üõ†Ô∏è Site is UNDER CONSTRUCTION (Scheduled)" : "‚úÖ Site is LIVE";
  maintenanceOverlay.style.display = (!isAdminPage && underMaintenance) ? "flex" : "none";
}

// ---------- Toggle Maintenance ----------
toggleBtn.addEventListener("click", async ()=>{
  try{
    const docSnap = await getDoc(maintenanceDoc);
    const current = docSnap.exists() ? docSnap.data().enabled : false;
    const scheduledDays = docSnap.exists() ? docSnap.data().scheduledDays || [] : [];
    await setDoc(maintenanceDoc, { enabled: !current, scheduledDays }, { merge: true });
    maintenanceMsg.textContent = !current ? "üõ†Ô∏è Site is UNDER CONSTRUCTION" : "‚úÖ Site is LIVE";
    alert(`‚úÖ Maintenance is now ${!current ? "ACTIVE" : "OFFLINE"}`);
    loadMaintenanceStatus();
  }catch(err){
    console.error(err);
    maintenanceMsg.textContent="‚ùå Error toggling status";
  }
});

// ---------- INITIAL ----------
loadMaintenanceStatus();

// ---------- TABLE LOGIC ----------
async function loadTable(){
  tableTitle.textContent=currentCollection;
  tableMsg.textContent="‚è≥ Loading...";
  dynamicTable.innerHTML="";
  actionButtonsDiv.innerHTML="";

  const snap = await getDocs(collection(db, currentCollection));
  if(snap.empty){ tableMsg.textContent="No documents found"; return; }
  tableMsg.textContent="";

  const keysSet = new Set();
  snap.forEach(docSnap=>Object.keys(docSnap.data()).forEach(k=>keysSet.add(k)));
  if(currentCategory==="Orders") keysSet.add("phone");
  if(currentCategory==="Products") { keysSet.add("stockStatus"); keysSet.add("itemsPerBox"); }
  const keys = Array.from(keysSet);

  const headerRow = dynamicTable.insertRow();
  headerRow.insertCell(0).textContent="ID";
  keys.forEach(k=>{ const th=document.createElement("th"); th.textContent=k; headerRow.appendChild(th); });
  if(currentCategory==="Products"){
    const th = document.createElement("th"); th.textContent="Restock Boxes"; headerRow.appendChild(th);
  }

  const now = Date.now();
  for(const docSnap of snap.docs){
    const data = docSnap.data();
    const row = dynamicTable.insertRow();
    row.dataset.id = docSnap.id;
    row.insertCell(0).textContent = docSnap.id;

    keys.forEach(key=>{
      const cell = row.insertCell();
      let value = data[key] ?? "";

      // ‚úÖ Convert Firestore timestamp objects
      if (value && typeof value === "object" && "seconds" in value && "nanoseconds" in value) {
        value = convertFirestoreTimestamp(value);
      } else if (Array.isArray(value)) {
        value = value.join(",");
      } else if (typeof value === "object" && value !== null) {
        value = JSON.stringify(value);
      }

      cell.textContent=value;
      cell.contentEditable=true;

      // ---------- Editable logic ----------
      cell.addEventListener("blur", async ()=>{
        let newValue = cell.textContent.trim();
        if(key==="phone"){ newValue=newValue.replace(/[^\d]/g,""); if(newValue.length===10) newValue=`(${newValue.slice(0,3)}) ${newValue.slice(3,6)}-${newValue.slice(6)}`; }

        if(key==="stock" || key==="itemsPerBox"){
          let numValue=parseInt(newValue)||0;
          const updatedData={...data,[key]:numValue};
          if(key==="stock"){ updatedData.stockStatus = numValue<1?"Out of Stock":"In Stock"; cell.textContent = numValue<1?"Out of Stock":numValue; if(numValue<1) cell.classList.add("out-of-stock"); else cell.classList.remove("out-of-stock"); }
          else{ cell.textContent=numValue; }
          try{ await setDoc(doc(db,currentCollection,row.dataset.id), updatedData); tableMsg.textContent=`‚úÖ ${key} updated!`; loadTable(); }catch(e){ console.error(e); tableMsg.textContent=`‚ùå Error updating ${key}`;}
          return;
        }

        if(typeof data[key]==="number") newValue=parseFloat(newValue)||0;
        else if(Array.isArray(data[key])) newValue=newValue.split(",").map(s=>s.trim()).filter(s=>s);
        else if(typeof data[key]==="object" && data[key]!==null){ try{ newValue=JSON.parse(newValue);}catch(e){ newValue=data[key]; } }

        if(currentCategory==="Orders"){
          const email = key==="email"?newValue:(data.email||"");
          const phone = key==="phone"?newValue:(data.phone||"");
          if(!email && !phone){ alert("‚ö†Ô∏è Must provide email or phone"); return; }
        }

        try{ await setDoc(doc(db,currentCollection,row.dataset.id), {...data,[key]:newValue}); tableMsg.textContent=`‚úÖ ${key} updated!`; }catch(err){ console.error(err); tableMsg.textContent=`‚ùå Error updating ${key}`;}
      });
    });

    // ---------- Products restock ----------
    if(currentCategory==="Products"){
      const restockCell=row.insertCell();
      const boxesInput=document.createElement("input"); boxesInput.type="number"; boxesInput.min=0; boxesInput.placeholder="Boxes to add"; restockCell.appendChild(boxesInput);
      const restockBtn=document.createElement("button"); restockBtn.textContent="Restock"; restockCell.appendChild(restockBtn);
      restockBtn.addEventListener("click", async ()=>{
        const boxes=parseInt(boxesInput.value)||0; if(boxes<=0){ alert("Enter a valid number of boxes"); return; }
        const itemsPerBox=parseInt(data.itemsPerBox)||1;
        const newStock=(data.stock||0)+(boxes*itemsPerBox);
        try{ await setDoc(doc(db,currentCollection,row.dataset.id), {...data, stock:newStock, stockStatus:newStock<1?"Out of Stock":"In Stock"}); boxesInput.value=""; alert(`‚úÖ Restocked ${boxes*itemsPerBox} items (${boxes} boxes)`); loadTable(); }catch(err){ console.error(err); alert("‚ùå Error restocking"); }
      });
    }

    // ---------- Highlight recent orders ----------
    if(currentCategory==="Orders" && data.timestamp){
      const orderTime = new Date(data.timestamp).getTime();
      if(now - orderTime < 24*60*60*1000) row.classList.add("recent-order");
    }
    if(currentCategory==="Orders" && data.status){
      const statusCell = [...row.cells].find(c=>c.textContent===data.status || c.textContent==='status');
      if(statusCell){ statusCell.classList.add(data.status.toLowerCase()==="completed"?"status-completed":"status-pending"); }
    }
  }

  // ---------- Delete buttons ----------
  if(currentCategory==="Orders" || currentCategory==="Products"){
    const checkboxTh=document.createElement("th"); checkboxTh.textContent="Select"; dynamicTable.rows[0].insertBefore(checkboxTh,dynamicTable.rows[0].cells[0]);
    [...dynamicTable.rows].slice(1).forEach(row=>{ const cell=row.insertCell(0); const cb=document.createElement("input"); cb.type="checkbox"; cell.appendChild(cb); });
    const delBtn=document.createElement("button"); delBtn.textContent = currentCategory==="Orders"?"üóë Delete Selected Orders":"üóë Delete Selected Products";
    delBtn.addEventListener("click", async ()=>{
      const selectedRows=[...dynamicTable.rows].slice(1).filter(r=>r.cells[0].firstChild.checked);
      if(selectedRows.length===0){ alert("No items selected."); return; }
      if(!confirm(`‚ö†Ô∏è Delete ${selectedRows.length} item(s)?`)) return;
      for(const row of selectedRows){ try{ await deleteDoc(doc(db,currentCollection,row.dataset.id)); }catch(e){ console.error(e);} }
      loadTable();
    });
    actionButtonsDiv.appendChild(delBtn);
  }

  searchInput.oninput=()=>{ const term=searchInput.value.toLowerCase(); [...dynamicTable.rows].forEach((row,i)=>{ if(i===0) return; row.style.display=row.textContent.toLowerCase().includes(term)?"":"none"; }); };
}
</script>
</body>
</html>

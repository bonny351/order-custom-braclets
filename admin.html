<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Admin Panel ‚Äì Tactics & Treats</title>
<style>
body{font-family:"Poppins",sans-serif;background:#111;color:white;margin:0;padding:20px;}
h1,h2{text-align:center;color:#ff0000;margin-bottom:20px;}
header{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#7a0c0c,#000);padding:10px 20px;border-radius:10px;box-shadow:0 0 12px rgba(255,0,0,0.4);margin-bottom:20px;}
header img{height:60px;width:60px;border-radius:50%;border:2px solid #ff0000;background:#000;}
header h1{flex:1;text-align:center;color:#ff0000;margin:0;}
section{background:#181818;padding:20px;border-radius:12px;box-shadow:0 0 12px rgba(255,0,0,0.2);margin-bottom:30px;transition:opacity .3s;}
.tabs,.subTabs{display:flex;justify-content:center;margin-bottom:15px;gap:10px;flex-wrap:wrap;}
.tab,.subTab{padding:10px 20px;cursor:pointer;border-radius:5px;background:#222;color:#fff;font-weight:bold;transition:.2s;}
.tab.active,.subTab.active{background:#ff0000;color:#fff;box-shadow:0 0 8px #ff0000;}
.tab:hover,.subTab:hover{background:#ff4444;}
table{width:100%;border-collapse:collapse;margin-top:10px;transition:opacity 0.3s ease;}
th,td{padding:10px;border:1px solid #ff0000;text-align:center;}
th{background:#222;color:#ffb347;position:sticky;top:0;z-index:1;}
tr:nth-child(even){background:#222;}
tr:hover{background:#333;transition:.2s;}
td:focus{outline:2px solid #ff0000;background:#222;}
#searchInput{width:100%;max-width:400px;margin:10px auto;display:block;padding:8px;border-radius:5px;border:none;font-size:14px;}
button{padding:8px 12px;margin:5px;background:#ff0000;color:white;font-weight:bold;border:none;border-radius:8px;cursor:pointer;transition:.2s;}
button:hover{background:darkred;box-shadow:0 0 8px #ff0000;}
.message{color:#ffb347;font-weight:bold;text-align:center;margin-top:10px;}
.status-pending{color:#ffb347;font-weight:bold;}
.status-completed{color:#0f0;font-weight:bold;}
.status-cancelled{color:#f00;font-weight:bold;}
.recent-order{background:rgba(255,255,255,0.1)!important;}
.out-of-stock{background:rgba(255,0,0,0.2);font-weight:bold;}
.flex{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;}
select{padding:4px 6px;border-radius:5px;border:none;background:#222;color:white;}
input[type=number]{width:70px;}
label{cursor:pointer;margin-right:6px;}
span.day{display:inline-block;padding:4px 8px;margin:2px;border-radius:4px;color:white;}
span.scheduled{background:red;}
span.unscheduled{background:#444;}

/* ‚úÖ Updated overlay fix */
.loadingOverlay {
  position:absolute;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  justify-content:center;
  align-items:center;
  color:#ffb347;
  font-weight:bold;
  font-size:20px;
  border-radius:12px;
  z-index:2;
  opacity:0;
  transition:opacity .3s;
  pointer-events:none; /* allows clicks when hidden */
}

.loadingOverlay.show {
  opacity:1;
  pointer-events:auto; /* only blocks clicks when visible */
}
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="Tactics & Treats Logo">
  <h1>Tactics & Treats Admin Panel</h1>
</header>

<div class="tabs" id="mainTabs"></div>
<div class="subTabs" id="collectionTabs"></div>

<section id="tableSection" style="position:relative;">
  <h2 id="tableTitle">Loading...</h2>
  <input type="text" id="searchInput" placeholder="üîç Search...">
  <p id="tableMsg" class="message"></p>
  <div class="loadingOverlay" id="loadingOverlay">‚è≥ Loading...</div>
  <table id="dynamicTable"></table>
  <div id="actionButtons" class="flex"></div>

  <hr style="border-color:#ff4444;">

  <button id="toggleMaintenanceBtn">‚ö†Ô∏è Toggle Under Construction</button>
  <button id="printCardsBtn">üñ® Print Business Cards</button>
  <p id="maintenanceMsg" class="message"></p>

  <div id="maintenanceScheduleDiv" style="text-align:center;margin-top:10px;"></div>
  <div id="maintenanceDaysDiv" style="text-align:center;margin-top:10px;"></div>
</section>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {getFirestore,collection,getDocs,doc,setDoc,deleteDoc,getDoc} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",authDomain:"bracelets-and-color.firebaseapp.com",projectId:"bracelets-and-color",storageBucket:"bracelets-and-color.appspot.com",messagingSenderId:"382292570673",appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

function convertFirestoreTimestamp(ts){
  if(ts&&typeof ts==="object"&&"seconds"in ts&&"nanoseconds"in ts){
    const ms=ts.seconds*1000+ts.nanoseconds/1e6;
    return new Date(ms).toLocaleString();
  }
  return ts;
}

const allCollections={
  "Products":["products","products_bracelets","products_cookies","products_spirit"],
  "Orders":["braceletOrders","cookieOrders","spiritOrders"],
  "Users":["users","activityLogs"],
  "Settings":["_meta","metadata","siteSettings","adminSettings","colors","braceletColors"]
};

const mainTabsDiv=document.getElementById("mainTabs");
const collectionTabsDiv=document.getElementById("collectionTabs");
const tableTitle=document.getElementById("tableTitle");
const dynamicTable=document.getElementById("dynamicTable");
const searchInput=document.getElementById("searchInput");
const tableMsg=document.getElementById("tableMsg");
const actionButtonsDiv=document.getElementById("actionButtons");
const toggleBtn=document.getElementById("toggleMaintenanceBtn");
const maintenanceMsg=document.getElementById("maintenanceMsg");
const maintenanceScheduleDiv=document.getElementById("maintenanceScheduleDiv");
const maintenanceDaysDiv=document.getElementById("maintenanceDaysDiv");
const printBtn=document.getElementById("printCardsBtn");
const loadingOverlay=document.getElementById("loadingOverlay");

let currentCategory="";let currentCollection="";
const days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const dayCheckboxes=[];
const maintenanceDoc=doc(db,"siteSettings","maintenance");

// Create category tabs
Object.keys(allCollections).forEach(cat=>{
  const tab=document.createElement("div");
  tab.className="tab";
  tab.textContent=cat;
  tab.addEventListener("click",()=>{
    currentCategory=cat;
    [...mainTabsDiv.children].forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    loadCollectionTabs();
  });
  mainTabsDiv.appendChild(tab);
});
mainTabsDiv.children[0].click();

function loadCollectionTabs(){
  collectionTabsDiv.innerHTML="";
  allCollections[currentCategory].forEach(coll=>{
    const subTab=document.createElement("div");
    subTab.className="subTab";
    subTab.textContent=coll;
    subTab.addEventListener("click",()=>{
      currentCollection=coll;
      [...collectionTabsDiv.children].forEach(t=>t.classList.remove("active"));
      subTab.classList.add("active");
      loadTable();
    });
    collectionTabsDiv.appendChild(subTab);
  });
  collectionTabsDiv.children[0].click();
}

// Maintenance functions
async function loadMaintenanceStatus(){
  try{
    const docSnap=await getDoc(maintenanceDoc);
    const data=docSnap.exists()?docSnap.data():{enabled:false,scheduledDays:[]};
    maintenanceMsg.textContent=data.enabled?"üõ†Ô∏è Site is UNDER CONSTRUCTION":"‚úÖ Site is LIVE";
    loadMaintenanceSchedule(data.scheduledDays||[]);
    displayScheduledDays(data.scheduledDays||[]);
  }catch(err){console.error(err);}
}
function displayScheduledDays(scheduledDays){
  maintenanceDaysDiv.innerHTML="<strong>Scheduled Maintenance Days:</strong><br>";
  days.forEach((day,i)=>{
    const span=document.createElement("span");
    span.className=scheduledDays.includes(i)?"day scheduled":"day unscheduled";
    span.textContent=day;
    maintenanceDaysDiv.appendChild(span);
  });
}
function loadMaintenanceSchedule(scheduledDays){
  maintenanceScheduleDiv.innerHTML="<strong>Schedule Maintenance:</strong><br>";
  days.forEach((day,i)=>{
    const label=document.createElement("label");
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.value=i;
    cb.checked=scheduledDays.includes(i);
    cb.addEventListener("change",()=>displayScheduledDays(dayCheckboxes.filter(cb=>cb.checked).map(cb=>parseInt(cb.value))));
    dayCheckboxes[i]=cb;
    label.appendChild(cb);
    label.appendChild(document.createTextNode(day));
    maintenanceScheduleDiv.appendChild(label);
  });
  const saveBtn=document.createElement("button");
  saveBtn.textContent="üíæ Save Schedule";
  saveBtn.addEventListener("click",saveSchedule);
  maintenanceScheduleDiv.appendChild(saveBtn);
}
async function saveSchedule(){
  const selectedDays=dayCheckboxes.filter(cb=>cb.checked).map(cb=>parseInt(cb.value));
  await setDoc(maintenanceDoc,{enabled:true,scheduledDays:selectedDays},{merge:true});
  alert("‚úÖ Maintenance schedule saved!");
  loadMaintenanceStatus();
}
toggleBtn.addEventListener("click",async()=>{
  const docSnap=await getDoc(maintenanceDoc);
  const current=docSnap.exists()?docSnap.data().enabled:false;
  const scheduledDays=docSnap.exists()?docSnap.data().scheduledDays||[]:[];
  await setDoc(maintenanceDoc,{enabled:!current,scheduledDays},{merge:true});
  maintenanceMsg.textContent=!current?"üõ†Ô∏è Site is UNDER CONSTRUCTION":"‚úÖ Site is LIVE";
  loadMaintenanceStatus();
});

// Print PDF button
printBtn.addEventListener("click",()=>{
  const pdfURL="Tactics & Treats.pdf";
  const printWindow=window.open(pdfURL,"_blank");
  if(!printWindow){alert("Please allow popups.");return;}
  printWindow.onload=()=>{printWindow.print();};
});

loadMaintenanceStatus();

// Table logic
async function loadTable(){
  const scrollY=window.scrollY;
  const tableHeight=dynamicTable.offsetHeight;
  dynamicTable.style.minHeight=tableHeight+"px";
  loadingOverlay.classList.add("show");

  tableTitle.textContent=currentCollection;
  const snap=await getDocs(collection(db,currentCollection));

  dynamicTable.style.opacity="0";
  if(snap.empty){
    tableMsg.textContent="No documents found";
    dynamicTable.innerHTML="";
    loadingOverlay.classList.remove("show");
    return;
  }

  dynamicTable.innerHTML="";
  const keysSet=new Set();
  snap.forEach(docSnap=>Object.keys(docSnap.data()).forEach(k=>keysSet.add(k)));
  const keys=Array.from(keysSet);
  const headerRow=dynamicTable.insertRow();
  headerRow.insertCell(0).textContent="ID";
  keys.forEach(k=>{const th=document.createElement("th");th.textContent=k;headerRow.appendChild(th);});

  for(const docSnap of snap.docs){
    const data=docSnap.data();
    const row=dynamicTable.insertRow();
    row.dataset.id=docSnap.id;
    row.insertCell(0).textContent=docSnap.id;
    keys.forEach(key=>{
      const cell=row.insertCell();
      let value=data[key]??"";
      if(value&&typeof value==="object"&&"seconds"in value)value=convertFirestoreTimestamp(value);
      else if(Array.isArray(value))value=value.join(",");
      else if(typeof value==="object"&&value!==null)value=JSON.stringify(value);
      cell.textContent=value;
      cell.contentEditable=true;
      cell.addEventListener("blur",async()=>{
        let newValue=cell.textContent.trim();
        try{
          await setDoc(doc(db,currentCollection,row.dataset.id),{...data,[key]:newValue});
          tableMsg.textContent=`‚úÖ ${key} updated!`;
        }catch(err){console.error(err);}
      });
    });
  }

  searchInput.oninput=()=>{const term=searchInput.value.toLowerCase();[...dynamicTable.rows].forEach((r,i)=>{if(i===0)return;r.style.display=r.textContent.toLowerCase().includes(term)?"":"none";});};

  dynamicTable.style.opacity="1";
  window.scrollTo(0,scrollY);
  dynamicTable.style.minHeight="";
  loadingOverlay.classList.remove("show");
}
</script>
</body>
</html>

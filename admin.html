<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactics & Treats â€“ Admin Panel</title>

<style>
body {
  font-family: "Poppins", sans-serif;
  background:#111;
  color:white;
  margin:0;
  padding:20px;
}

h1,h2 { text-align:center; color:#ff0000; }

header {
  display:flex;
  justify-content:center;
  background:linear-gradient(90deg,#7a0c0c,#000);
  padding:15px;
  border-radius:10px;
  box-shadow:0 0 12px rgba(255,0,0,0.4);
  margin-bottom:15px;
}

.tabs {
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:15px;
  flex-wrap:wrap;
}

.tab {
  padding:10px 20px;
  cursor:pointer;
  border-radius:5px;
  background:#222;
  font-weight:bold;
}

.tab.active {
  background:#ff0000;
  box-shadow:0 0 8px #ff0000;
}

.dashboard {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:12px;
  margin-bottom:15px;
}

.stat {
  background:#181818;
  padding:12px;
  border-radius:10px;
  box-shadow:0 0 10px rgba(255,0,0,.25);
  text-align:center;
}

.stat h3 { margin:0; color:#ffb347; }
.stat p { font-size:20px; margin:5px 0 0; }

section {
  background:#181818;
  padding:20px;
  border-radius:12px;
  box-shadow:0 0 12px rgba(255,0,0,0.2);
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

th,td {
  border:1px solid #ff0000;
  padding:8px;
  text-align:center;
}

tr:nth-child(even) { background:#222; }

.statusSelect {
  background:#222;
  color:white;
  border:1px solid #ff0000;
  border-radius:5px;
}

/* STATUS COLORS */
.newRow { background:rgba(255,255,0,0.25)!important; }
.doneRow { background:rgba(0,255,0,0.25)!important; }
.unpaidRow { background:rgba(255,0,0,0.25)!important; }
</style>
</head>

<body>

<header><h1>Tactics & Treats Admin Panel</h1></header>

<div class="tabs">
  <div class="tab active" onclick="switchCollection('braceletOrders')">Bracelet Orders</div>
  <div class="tab" onclick="switchCollection('cookieOrders')">Cookie Orders</div>
  <div class="tab" onclick="switchCollection('spiritOrders')">Spirit Wear</div>
  <div class="tab" onclick="switchCollection('products_bracelets')">Bracelet Products</div>
  <div class="tab" onclick="switchCollection('auditLog')">Audit Log</div>
</div>

<div class="dashboard" id="dashboard">
  <div class="stat"><h3>Today</h3><p id="todayCount">0</p></div>
  <div class="stat"><h3>This Week</h3><p id="weekCount">0</p></div>
  <div class="stat"><h3>Revenue</h3><p id="revenue">$0</p></div>
</div>

<section>
  <h2 id="tableTitle">Bracelet Orders</h2>
  <table id="table"></table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  doc, setDoc, addDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE */
const firebaseConfig = {
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentCollection = "braceletOrders";
const table = document.getElementById("table");

/* SWITCH */
window.switchCollection = col => {
  currentCollection = col;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  event.target.classList.add("active");
  document.getElementById("tableTitle").textContent = col;
  loadTable();
};

/* DASHBOARD */
function updateDashboard(rows){
  let today=0, week=0, revenue=0;
  const now=new Date();

  rows.forEach(r=>{
    const d=r.createdAt?.toDate?.() || new Date(r.createdAt);
    const diff=(now-d)/86400000;

    if(diff<1) today++;
    if(diff<7) week++;
    if(r.price && r.qty) revenue += r.price * r.qty;
  });

  todayCount.textContent=today;
  weekCount.textContent=week;
  revenue.textContent="$"+revenue.toFixed(2);
}

/* STATUS COLOR */
function colorRow(row,status){
  row.classList.remove("newRow","doneRow","unpaidRow");
  if(status==="new") row.classList.add("newRow");
  if(status==="done") row.classList.add("doneRow");
  if(status==="unpaid") row.classList.add("unpaidRow");
}

/* LOAD TABLE */
async function loadTable(){
  table.innerHTML="";

  const snap = await getDocs(collection(db,currentCollection));
  const rows = snap.docs.map(d=>({id:d.id,...d.data()}));

  if(currentCollection.includes("Orders")) updateDashboard(rows);

  if(rows.length===0){
    table.innerHTML="<tr><td>No Data</td></tr>";
    return;
  }

  const keys=new Set(["status"]);
  rows.forEach(r=>Object.keys(r).forEach(k=>keys.add(k)));
  const cols=[...keys];

  const header=table.insertRow();
  cols.forEach(c=>header.insertCell().textContent=c);

  rows.forEach(r=>{
    const row=table.insertRow();

    cols.forEach(c=>{
      const cell=row.insertCell();

      if(c==="status"){
        const s=document.createElement("select");
        s.className="statusSelect";
        ["new","done","unpaid"].forEach(v=>{
          const o=new Option(v,v);
          if(r.status===v) o.selected=true;
          s.add(o);
        });
        s.onchange=async()=>{
          const old=r.status;
          r.status=s.value;
          await setDoc(doc(db,currentCollection,r.id),r);
          await addDoc(collection(db,"auditLog"),{
            type:"status_change",
            collection:currentCollection,
            id:r.id,
            from:old,
            to:r.status,
            at:new Date()
          });
          colorRow(row,r.status);
        };
        cell.appendChild(s);
      } else {
        cell.textContent=r[c] ?? "";
        cell.contentEditable=true;
        cell.onblur=async()=>{
          const old=r[c];
          r[c]=cell.textContent.trim();
          await setDoc(doc(db,currentCollection,r.id),r);
          await addDoc(collection(db,"auditLog"),{
            type:"edit",
            collection:currentCollection,
            id:r.id,
            field:c,
            from:old,
            to:r[c],
            at:new Date()
          });
        };
      }
    });

    colorRow(row,r.status);
  });
}

loadTable();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactics & Treats – Admin Panel</title>

<style>
body {
  font-family: "Poppins", sans-serif;
  background:#111;
  color:white;
  margin:0;
  padding:20px;
}
h1, h2 {
  text-align:center;
  color:#ff0000;
}

header {
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(90deg,#7a0c0c,#000);
  padding:15px;
  border-radius:10px;
  margin-bottom:20px;
}

.tabs, .subTabs {
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}

.tab, .subTab {
  background:#222;
  padding:10px 20px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  transition:.2s;
}
.tab.active, .subTab.active {
  background:#ff0000;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th, td {
  padding:10px;
  border:1px solid #ff0000;
  text-align:center;
}

.statusSelect {
  padding:6px;
  background:#222;
  color:white;
  border-radius:6px;
  border:1px solid #ff0000;
}

.row-green   { background:rgba(0,255,0,0.2); }
.row-yellow  { background:rgba(255,255,0,0.25); }
.row-red     { background:rgba(255,0,0,0.25); }

</style>
</head>
<body>

<header><h1>Tactics & Treats – Admin Panel</h1></header>

<div class="tabs" id="mainTabs"></div>
<div class="subTabs" id="subTabs"></div>

<h2 id="tableTitle">Loading...</h2>
<input id="searchInput" type="text" placeholder="Search..." style="width:90%;max-width:400px;display:block;margin:0 auto 10px;">

<table id="dataTable"></table>

<p id="msg" style="text-align:center;color:#ffb347;"></p>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, setDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const collections = {
  "Products": ["products", "products_bracelets", "products_cookies", "products_spirit"],
  "Orders": ["braceletOrders", "cookieOrders", "spiritOrders"],
  "Users": ["users"],
  "Settings": ["siteSettings"]
};

const mainTabs = document.getElementById("mainTabs");
const subTabs = document.getElementById("subTabs");
const table = document.getElementById("dataTable");
const msg = document.getElementById("msg");
const tableTitle = document.getElementById("tableTitle");
const searchInput = document.getElementById("searchInput");

let currentCollection = "";

/* CREATE MAIN TABS */
Object.keys(collections).forEach(cat => {
  const t = document.createElement("div");
  t.className = "tab";
  t.textContent = cat;

  t.onclick = () => {
    [...mainTabs.children].forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    loadSubTabs(cat);
  };

  mainTabs.appendChild(t);
});
mainTabs.children[0].click();

/* CREATE SUBTABS */
function loadSubTabs(cat) {
  subTabs.innerHTML = "";
  collections[cat].forEach(sub => {
    const st = document.createElement("div");
    st.className = "subTab";
    st.textContent = sub;

    st.onclick = () => {
      [...subTabs.children].forEach(x => x.classList.remove("active"));
      st.classList.add("active");
      currentCollection = sub;
      loadTable(sub);
    };

    subTabs.appendChild(st);
  });
  subTabs.children[0].click();
}

/* APPLY STATUS COLOR */
function colorRow(row, status) {
  row.classList.remove("row-green","row-red","row-yellow");

  if (status === "Paid in Cash" || status === "Paid by Card")
    row.classList.add("row-green");
  else if (status === "Unpaid")
    row.classList.add("row-red");
  else if (status === "Pending")
    row.classList.add("row-yellow");
}

/* STATUS DROPDOWN */
function makeStatusDropdown(row, data, id) {
  const select = document.createElement("select");
  select.className = "statusSelect";

  ["Paid in Cash","Paid by Card","Unpaid","Pending"].forEach(s => {
    const opt = new Option(s,s);
    if (data.status === s) opt.selected = true;
    select.add(opt);
  });

  colorRow(row, data.status);

  select.onchange = async () => {
    const newStatus = select.value;
    try {
      await setDoc(doc(db, currentCollection, id), {
        ...data,
        status:newStatus
      });

      data.status = newStatus;
      colorRow(row, newStatus);
      msg.textContent = "✔ Status Updated";
    } catch {
      msg.textContent = "❌ Error Updating";
    }
  };

  return select;
}

/* LOAD TABLE */
async function loadTable(colName) {
  table.innerHTML = "";
  tableTitle.textContent = colName;

  const snap = await getDocs(collection(db,colName));
  const docs = snap.docs;

  if (docs.length === 0) {
    table.innerHTML = "<tr><td>No data</td></tr>";
    return;
  }

  const allKeys = new Set(["status"]); // always include status
  docs.forEach(d => Object.keys(d.data()).forEach(k => allKeys.add(k)));

  const keys = [...allKeys];

  /* HEADER */
  const header = table.insertRow();
  header.insertCell().textContent = "Status";
  keys.forEach(k => header.insertCell().textContent = k);

  /* ROWS */
  docs.forEach(docSnap => {
    const row = table.insertRow();
    const data = docSnap.data();

    // STATUS CELL
    const stCell = row.insertCell();
    stCell.appendChild(makeStatusDropdown(row, data, docSnap.id));

    // DATA CELLS
    keys.forEach(k => {
      const cell = row.insertCell();
      cell.textContent = data[k] ?? "";
      cell.contentEditable = true;

      cell.onblur = async () => {
        const v = cell.textContent.trim();
        try {
          await setDoc(doc(db,colName,docSnap.id), {
            ...data,
            [k]:v
          });
          data[k] = v;
          msg.textContent = `✔ Updated ${k}`;
        } catch {
          msg.textContent = "❌ Error Updating";
        }
      };
    });

    // APPLY COLOR
    colorRow(row, data.status);
  });
}

/* SEARCH FILTER */
searchInput.oninput = () => {
  const term = searchInput.value.toLowerCase();
  [...table.rows].forEach((r,i)=>{
    if (i===0) return;
    r.style.display = r.textContent.toLowerCase().includes(term) ? "" : "none";
  });
};

</script>

</body>
</html>

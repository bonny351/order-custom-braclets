<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Dashboard | Tactics & Treats</title>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background:black;
    color:white;
    margin:0;
    padding:0;
  }
  h1,h2 {
    text-align:center;
    color:red;
    margin:20px 0;
  }

  table {
    width:95%;
    margin:20px auto;
    border-collapse:collapse;
    background:#111;
    border-radius:10px;
    overflow:hidden;
  }
  th,td {
    padding:10px;
    border-bottom:1px solid #333;
    text-align:center;
  }
  th { background:red; color:white; }
  tr:hover { background:#222; }
  button {
    background:red;
    border:none;
    color:white;
    padding:10px 15px;
    border-radius:8px;
    cursor:pointer;
    margin:10px;
    transition:background .2s;
  }
  button:hover { background:#ff4444; }
  [contenteditable="true"] { background:#222; border-radius:4px; outline:none; }
  [contenteditable="true"]:focus { background:#333; box-shadow:0 0 0 2px red; }
  select { background:#222; color:white; border:1px solid red; border-radius:5px; padding:5px; }
  select:focus { outline:none; box-shadow:0 0 0 2px red; }

  /* modal */
  #productModal {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    justify-content:center;
    align-items:center;
    z-index:1000;
    opacity:0;
    transition:opacity .25s ease;
  }
  #productModal.show {
    display:flex;
    opacity:1;
  }
  .modal-content {
    background:#111;
    color:white;
    padding:20px;
    border-radius:10px;
    width:90%;
    max-width:420px;
    box-shadow:0 0 20px red;
    position:relative;
    animation:slideIn .25s ease;
  }
  @keyframes slideIn {
    from{ transform:translateY(-10px); opacity:0 }
    to{ transform:translateY(0); opacity:1 }
  }
  #productModal input, #productModal select {
    width:100%;
    margin-bottom:12px;
    padding:8px;
    border-radius:6px;
    border:1px solid red;
    background:#222;
    color:white;
  }
  #closeModal {
    position:absolute;
    top:10px;
    right:12px;
    background:none;
    border:none;
    color:red;
    font-size:22px;
    cursor:pointer;
  }
  .muted { color:#aaa; font-size:.9rem; }
</style>
</head>
<body>
<h1>Admin Dashboard</h1>

<!-- ORDERS -->
<div class="section">
  <h2>Orders</h2>
  <table>
    <thead>
      <tr>
        <th>Order #</th><th>Name</th><th>Email</th><th>Product</th><th>Type</th><th>Qty</th><th>Total</th><th>Status</th>
      </tr>
    </thead>
    <tbody id="ordersBody"></tbody>
  </table>
</div>

<!-- PRODUCTS -->
<div class="section">
  <h2>Products</h2>
  <div style="text-align:center;">
    <button id="addProduct">‚ûï Add Product</button>
    <button id="generateSKU">üî¢ Generate Missing SKUs</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Name / Type</th><th>Size</th><th>Product Type</th><th>SKU</th><th>Supplier</th><th>Stock</th><th>Status</th><th>Price</th><th>Delete</th>
      </tr>
    </thead>
    <tbody id="productBody"></tbody>
  </table>
</div>

<!-- ADD PRODUCT MODAL -->
<div id="productModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button id="closeModal" title="Close">‚úñ</button>
    <h3 id="modalTitle" style="text-align:center;color:red;margin:0 0 12px 0;">Add New Product</h3>

    <label>Product Type</label>
    <select id="productType">
      <option value="cookie">Cookie</option>
      <option value="bracelet">Bracelet</option>
    </select>

    <label>Name / Type</label>
    <input id="productName" placeholder="e.g. Chocolate Chip or Red Rope" autocomplete="off" />

    <div id="braceletOptions" style="display:none;">
      <label>Size</label>
      <input id="productSize" placeholder="e.g. Small, Medium, Large" />
    </div>

    <label>Price ($)</label>
    <input id="productPrice" type="number" step="0.01" value="5.00" />

    <label>Stock</label>
    <input id="productStock" type="number" value="10" />

    <label>Supplier <span class="muted">(optional)</span></label>
    <input id="productSupplier" placeholder="e.g. Local Vendor" />

    <button id="saveProduct">‚úÖ Add Product</button>
  </div>
</div>

<script type="module">
/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain: "bracelets-and-color.firebaseapp.com",
  projectId: "bracelets-and-color",
  storageBucket: "bracelets-and-color.appspot.com",
  messagingSenderId: "382292570673",
  appId: "1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM references */
const ordersBody = document.getElementById("ordersBody");
const productBody = document.getElementById("productBody");
const generateSKU = document.getElementById("generateSKU");
const addProduct = document.getElementById("addProduct");

const modal = document.getElementById("productModal");
const closeModalBtn = document.getElementById("closeModal");
const productTypeSelect = document.getElementById("productType");
const braceletOptions = document.getElementById("braceletOptions");
const productNameInput = document.getElementById("productName");
const productSizeInput = document.getElementById("productSize");
const productPriceInput = document.getElementById("productPrice");
const productStockInput = document.getElementById("productStock");
const productSupplierInput = document.getElementById("productSupplier");
const saveBtn = document.getElementById("saveProduct");

/* ---------- ORDERS ---------- */
async function loadOrders() {
  try {
    const [cookieSnap, braceletSnap] = await Promise.all([
      getDocs(collection(db, "cookieOrders")),
      getDocs(collection(db, "braceletOrders"))
    ]);
    const all = [];
    cookieSnap.forEach(d => all.push({ id: d.id, ...d.data(), collection: "cookieOrders", type: "Cookie" }));
    braceletSnap.forEach(d => all.push({ id: d.id, ...d.data(), collection: "braceletOrders", type: "Bracelet" }));
    ordersBody.innerHTML = "";
    all.forEach(o => {
      const price = typeof o.totalPrice === "number" ? `$${o.totalPrice.toFixed(2)}` : (o.totalPrice ? `$${Number(o.totalPrice).toFixed(2)}` : "$0.00");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${o.orderNumber || "-"}</td>
        <td contenteditable="true" data-field="name">${o.name || "-"}</td>
        <td contenteditable="true" data-field="email">${o.email || "-"}</td>
        <td contenteditable="true" data-field="productName">${o.productName || o.type || "-"}</td>
        <td>${o.type}</td>
        <td contenteditable="true" data-field="quantity">${o.quantity ?? 1}</td>
        <td contenteditable="true" data-field="totalPrice">${price}</td>
        <td>
          <select data-field="status">
            <option value="Pending" ${o.status==="Pending" ? "selected":""}>Pending</option>
            <option value="Processing" ${o.status==="Processing" ? "selected":""}>Processing</option>
            <option value="Completed" ${o.status==="Completed" ? "selected":""}>Completed</option>
            <option value="Cancelled" ${o.status==="Cancelled" ? "selected":""}>Cancelled</option>
          </select>
        </td>
      `;
      row.querySelectorAll("[contenteditable]").forEach(cell => {
        const field = cell.dataset.field;
        cell.addEventListener("blur", async e => {
          let value = e.target.innerText.replace("$","").trim();
          if (["totalPrice","quantity"].includes(field)) value = Number(value);
          try { await updateDoc(doc(db, o.collection, o.id), { [field]: value }); } catch(err){ alert("Save failed"); }
        });
      });
      row.querySelector("select[data-field='status']").addEventListener("change", async e => {
        await updateDoc(doc(db, o.collection, o.id), { status: e.target.value });
      });
      ordersBody.appendChild(row);
    });
  } catch (err) { console.error("loadOrders error", err); }
}

/* ---------- PRODUCTS ---------- */
async function loadProducts() {
  const [cookieSnap, braceletSnap] = await Promise.all([
    getDocs(collection(db, "products_cookies")),
    getDocs(collection(db, "products_bracelets"))
  ]);
  productBody.innerHTML = "";
  const allProducts = [];
  cookieSnap.forEach(d => allProducts.push({ id: d.id, ...d.data(), collection: "products_cookies", productType: "Cookie" }));
  braceletSnap.forEach(d => allProducts.push({ id: d.id, ...d.data(), collection: "products_bracelets", productType: "Bracelet" }));

  allProducts.forEach(p => {
    const isBracelet = p.collection === "products_bracelets";
    const displayName = isBracelet ? (p.type || "Unnamed") : (p.name || "Unnamed");
    const displaySize = isBracelet ? (p.size || "-") : "-";
    const stock = Number(p.stock ?? 0);
    const basePrice = Number(p.price ?? 0);
    const adjustedPrice = (stock > 0 && stock <= 10) ? basePrice + 1 : basePrice;
    const status = stock <= 0 ? "Out of Stock" : stock <= 10 ? "Low Stock" : "In Stock";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td contenteditable="true" data-field="${isBracelet ? 'type' : 'name'}">${displayName}</td>
      <td contenteditable="${isBracelet}" data-field="${isBracelet ? 'size' : ''}">${displaySize}</td>
      <td>${p.productType}</td>
      <td contenteditable="true" data-field="sku">${p.sku || "-"}</td>
      <td contenteditable="true" data-field="supplier">${p.supplier || "-"}</td>
      <td contenteditable="true" data-field="stock">${stock}</td>
      <td>${status}</td>
      <td contenteditable="true" data-field="price">$${adjustedPrice.toFixed(2)}</td>
      <td><button class="delete-btn" data-id="${p.id}" data-col="${p.collection}">üóëÔ∏è</button></td>
    `;

    row.querySelectorAll("[contenteditable]").forEach(cell => {
      const field = cell.dataset.field;
      if (!field) return;
      cell.addEventListener("blur", async e => {
        let value = e.target.innerText.replace("$","").trim();
        if (["stock","price"].includes(field)) value = Number(value);
        await updateDoc(doc(db, p.collection, p.id), { [field]: value });
        loadProducts();
      });
    });
    row.querySelector(".delete-btn").addEventListener("click", async () => {
      if (confirm(`Delete "${displayName}"?`)) {
        await deleteDoc(doc(db, p.collection, p.id));
        loadProducts();
      }
    });
    productBody.appendChild(row);
  });
}

/* ---------- MODAL ---------- */
function openModal() {
  productTypeSelect.value = "cookie";
  braceletOptions.style.display = "none";
  productNameInput.value = "";
  productSizeInput.value = "";
  productPriceInput.value = "5.00";
  productStockInput.value = "10";
  productSupplierInput.value = "";
  modal.classList.add("show");
  setTimeout(()=>productNameInput.focus(),150);
}
function closeModal() {
  modal.classList.remove("show");
}
addProduct.addEventListener("click", openModal);
closeModalBtn.addEventListener("click", closeModal);
modal.addEventListener("click", e => { if (e.target===modal) closeModal(); });
document.addEventListener("keydown", e => { if (e.key==="Escape") closeModal(); });
productTypeSelect.addEventListener("change", () => {
  braceletOptions.style.display = productTypeSelect.value==="bracelet" ? "block" : "none";
});
saveBtn.addEventListener("click", async () => {
  const type = productTypeSelect.value;
  const name = productNameInput.value.trim();
  const size = productSizeInput.value.trim();
  const price = parseFloat(productPriceInput.value);
  const stock = parseInt(productStockInput.value);
  const supplier = productSupplierInput.value.trim() || "-";
  if (!name || isNaN(price) || isNaN(stock)) return alert("Please fill all fields.");
  const data = {
    name: type==="cookie"?name:undefined,
    type: type==="bracelet"?name:undefined,
    price, stock, supplier,
    size: type==="bracelet"?size||"-":undefined,
    sku: `${type==="bracelet"?"BR":"CK"}-${Math.random().toString(36).substring(2,7).toUpperCase()}`
  };
  const col = type==="cookie"?"products_cookies":"products_bracelets";
  await addDoc(collection(db,col),data);
  alert("‚úÖ Product added!");
  closeModal();
  loadProducts();
});

/* ---------- GENERATE SKU ---------- */
generateSKU.addEventListener("click", async () => {
  const collections = ["products_cookies","products_bracelets"];
  for (const col of collections) {
    const snap = await getDocs(collection(db,col));
    for (const d of snap.docs) {
      if (!d.data().sku) {
        const prefix = col.includes("bracelet")?"BR":"CK";
        const sku = `${prefix}-${Math.random().toString(36).substring(2,7).toUpperCase()}`;
        await updateDoc(doc(db,col,d.id),{sku});
      }
    }
  }
  alert("‚úÖ All missing SKUs generated!");
  loadProducts();
});

/* ---------- INIT ---------- */
loadOrders();
loadProducts();
</script>
</body>
</html>

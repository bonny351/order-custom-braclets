<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Dashboard | Tactics & Treats</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#000;
    --panel:#111;
    --accent:red;
    --text:white;
    --muted:#aaa;
  }

  body {
    font-family:'Poppins',sans-serif;
    background:var(--bg);
    color:var(--text);
    margin:0;
    padding:0;
  }

  h1,h2 { text-align:center; color:var(--accent); margin:20px 0; }

  main { padding-bottom:60px; }

  table {
    width:95%;
    margin:20px auto;
    border-collapse:collapse;
    background:var(--panel);
    border-radius:10px;
    overflow:hidden;
  }
  th,td {
    padding:10px;
    border-bottom:1px solid #333;
    text-align:center;
  }
  th { background:var(--accent); color:var(--text); }
  tr:hover { background:#1a1a1a; }

  button {
    background:var(--accent);
    border:none;
    color:var(--text);
    padding:10px 15px;
    border-radius:8px;
    cursor:pointer;
    margin:8px;
    transition:background .2s;
  }
  button:hover, button:focus { background:#ff4444; outline:none; }

  [contenteditable="true"] {
    background:#222;
    border-radius:4px;
    outline:none;
    transition:background .2s;
  }
  [contenteditable="true"]:focus {
    background:#333;
    box-shadow:0 0 0 2px var(--accent);
  }

  select, input {
    background:#222;
    color:var(--text);
    border:1px solid var(--accent);
    border-radius:5px;
    padding:6px;
  }
  select:focus, input:focus { outline:none; box-shadow:0 0 0 2px var(--accent); }

  /* Responsive table wrapper */
  .table-wrapper { overflow-x:auto; }

  /* Modal */
  #productModal {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:1000;
    opacity:0;
    visibility:hidden;
    transition:opacity .25s ease, visibility .25s;
  }
  #productModal.show {
    opacity:1;
    visibility:visible;
  }
  .modal-content {
    background:var(--panel);
    color:var(--text);
    padding:20px;
    border-radius:10px;
    width:90%;
    max-width:420px;
    box-shadow:0 0 20px var(--accent);
    position:relative;
    animation:slideIn .25s ease;
  }
  @keyframes slideIn {
    from{ transform:translateY(-10px); opacity:0 }
    to{ transform:translateY(0); opacity:1 }
  }
  #closeModal {
    position:absolute;
    top:10px;
    right:12px;
    background:none;
    border:none;
    color:var(--accent);
    font-size:22px;
    cursor:pointer;
  }
  .muted { color:var(--muted); font-size:.9rem; }

  /* Toast feedback */
  #toast {
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:#222;
    border:1px solid var(--accent);
    color:var(--text);
    padding:10px 18px;
    border-radius:6px;
    opacity:0;
    transition:opacity .3s, transform .3s;
    z-index:2000;
  }
  #toast.show { opacity:1; transform:translateX(-50%) translateY(-10px); }

  @media (max-width:700px) {
    th,td { font-size:0.9rem; padding:6px; }
    button { padding:8px 12px; font-size:0.9rem; }
  }
</style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <main>

  <!-- ORDERS -->
  <section>
    <h2>Orders</h2>
    <div class="table-wrapper">
      <table aria-label="Orders Table">
        <thead>
          <tr>
            <th>Order #</th><th>Name</th><th>Email</th><th>Product</th><th>Type</th><th>Qty</th><th>Total</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
  </section>

  <!-- PRODUCTS -->
  <section>
    <h2>Products</h2>
    <div style="text-align:center;">
      <button id="addProduct" type="button">➕ Add Product</button>
      <button id="generateSKU" type="button">🔢 Generate Missing SKUs</button>
    </div>
    <div class="table-wrapper">
      <table aria-label="Products Table">
        <thead>
          <tr>
            <th>Name / Type</th><th>Size</th><th>Product Type</th><th>SKU</th><th>Supplier</th><th>Stock</th><th>Status</th><th>Price</th><th>Delete</th>
          </tr>
        </thead>
        <tbody id="productBody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- ADD PRODUCT MODAL -->
<div id="productModal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
  <div class="modal-content">
    <button id="closeModal" title="Close" aria-label="Close modal">✖</button>
    <h3 id="modalTitle" style="text-align:center;color:var(--accent);margin:0 0 12px;">Add New Product</h3>

    <form id="productForm">
      <label>Product Type</label>
      <select id="productType">
        <option value="cookie">Cookie</option>
        <option value="bracelet">Bracelet</option>
      </select>

      <label>Name / Type</label>
      <input id="productName" placeholder="e.g. Chocolate Chip or Red Rope" required />

      <div id="braceletOptions" style="display:none;">
        <label>Size</label>
        <input id="productSize" placeholder="e.g. Small, Medium, Large" />
      </div>

      <label>Price ($)</label>
      <input id="productPrice" type="number" step="0.01" min="0" required value="5.00" />

      <label>Stock</label>
      <input id="productStock" type="number" min="0" required value="10" />

      <label>Supplier <span class="muted">(optional)</span></label>
      <input id="productSupplier" placeholder="e.g. Local Vendor" />

      <button id="saveProduct" type="submit">✅ Add Product</button>
    </form>
  </div>
</div>

<div id="toast"></div>

<script type="module">
/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain: "bracelets-and-color.firebaseapp.com",
  projectId: "bracelets-and-color",
  storageBucket: "bracelets-and-color.appspot.com",
  messagingSenderId: "382292570673",
  appId: "1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM references */
const ordersBody = document.getElementById("ordersBody");
const productBody = document.getElementById("productBody");
const modal = document.getElementById("productModal");
const productTypeSelect = document.getElementById("productType");
const braceletOptions = document.getElementById("braceletOptions");
const productForm = document.getElementById("productForm");
const toast = document.getElementById("toast");

/* Toast helper */
function showToast(msg, duration=2000){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), duration);
}

/* Utility */
function escapeHTML(str){
  return str?.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) || "";
}

/* ---------- ORDERS ---------- */
async function loadOrders(){
  try{
    const [cookieSnap, braceletSnap] = await Promise.all([
      getDocs(collection(db,"cookieOrders")),
      getDocs(collection(db,"braceletOrders"))
    ]);
    ordersBody.innerHTML = "";
    const all = [];
    cookieSnap.forEach(d=>all.push({id:d.id,...d.data(),collection:"cookieOrders",type:"Cookie"}));
    braceletSnap.forEach(d=>all.push({id:d.id,...d.data(),collection:"braceletOrders",type:"Bracelet"}));
    all.forEach(o=>{
      const price = Number(o.totalPrice) ? `$${Number(o.totalPrice).toFixed(2)}` : "$0.00";
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${escapeHTML(o.orderNumber||"-")}</td>
        <td contenteditable="true" data-field="name">${escapeHTML(o.name||"-")}</td>
        <td contenteditable="true" data-field="email">${escapeHTML(o.email||"-")}</td>
        <td contenteditable="true" data-field="productName">${escapeHTML(o.productName||o.type||"-")}</td>
        <td>${o.type}</td>
        <td contenteditable="true" data-field="quantity">${o.quantity??1}</td>
        <td contenteditable="true" data-field="totalPrice">${price}</td>
        <td>
          <select data-field="status">
            ${["Pending","Processing","Completed","Cancelled"].map(s=>`<option ${o.status===s?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>`;
      tr.querySelectorAll("[contenteditable]").forEach(cell=>{
        const field=cell.dataset.field;
        let timeout;
        cell.addEventListener("input",()=>{
          clearTimeout(timeout);
          timeout=setTimeout(async()=>{
            let val=cell.innerText.trim().replace("$","");
            if(["quantity","totalPrice"].includes(field)) val=Number(val);
            try{ await updateDoc(doc(db,o.collection,o.id),{[field]:val}); showToast("Saved"); }
            catch{ showToast("Save failed"); }
          },600);
        });
      });
      tr.querySelector("select[data-field='status']").addEventListener("change",async e=>{
        await updateDoc(doc(db,o.collection,o.id),{status:e.target.value});
        showToast("Status updated");
      });
      ordersBody.appendChild(tr);
    });
  }catch(err){ console.error(err); showToast("Failed to load orders"); }
}

/* ---------- PRODUCTS ---------- */
async function loadProducts(){
  const [cookieSnap,braceletSnap]=await Promise.all([
    getDocs(collection(db,"products_cookies")),
    getDocs(collection(db,"products_bracelets"))
  ]);
  productBody.innerHTML="";
  const all=[];
  cookieSnap.forEach(d=>all.push({id:d.id,...d.data(),collection:"products_cookies",productType:"Cookie"}));
  braceletSnap.forEach(d=>all.push({id:d.id,...d.data(),collection:"products_bracelets",productType:"Bracelet"}));

  all.forEach(p=>{
    const isBracelet=p.collection.includes("bracelets");
    const name=isBracelet?p.type:p.name;
    const size=isBracelet?p.size:"-";
    const stock=Number(p.stock||0);
    const price=Number(p.price||0);
    const status=stock<=0?"Out of Stock":stock<=10?"Low Stock":"In Stock";
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td contenteditable="true" data-field="${isBracelet?"type":"name"}">${escapeHTML(name||"Unnamed")}</td>
      <td contenteditable="${isBracelet}" data-field="${isBracelet?"size":""}">${escapeHTML(size)}</td>
      <td>${p.productType}</td>
      <td contenteditable="true" data-field="sku">${escapeHTML(p.sku||"-")}</td>
      <td contenteditable="true" data-field="supplier">${escapeHTML(p.supplier||"-")}</td>
      <td contenteditable="true" data-field="stock">${stock}</td>
      <td>${status}</td>
      <td contenteditable="true" data-field="price">$${price.toFixed(2)}</td>
      <td><button class="delete-btn" data-id="${p.id}" data-col="${p.collection}" aria-label="Delete ${name}">🗑️</button></td>`;
    tr.querySelectorAll("[contenteditable]").forEach(cell=>{
      const field=cell.dataset.field;
      if(!field) return;
      let timer;
      cell.addEventListener("input",()=>{
        clearTimeout(timer);
        timer=setTimeout(async()=>{
          let val=cell.innerText.trim().replace("$","");
          if(["stock","price"].includes(field)) val=Number(val);
          try{ await updateDoc(doc(db,p.collection,p.id),{[field]:val}); showToast("Updated"); }
          catch{ showToast("Failed to update"); }
        },600);
      });
    });
    tr.querySelector(".delete-btn").addEventListener("click",async()=>{
      if(confirm(`Delete "${name}"?`)){
        await deleteDoc(doc(db,p.collection,p.id));
        showToast("Deleted");
        loadProducts();
      }
    });
    productBody.appendChild(tr);
  });
}

/* ---------- MODAL ---------- */
function openModal(){
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");
  document.body.style.overflow="hidden";
  productForm.reset();
  braceletOptions.style.display="none";
  productTypeSelect.focus();
}
function closeModal(){
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden","true");
  document.body.style.overflow="";
}
document.getElementById("addProduct").onclick=openModal;
document.getElementById("closeModal").onclick=closeModal;
modal.addEventListener("click",e=>{ if(e.target===modal) closeModal(); });
document.addEventListener("keydown",e=>{ if(e.key==="Escape") closeModal(); });
productTypeSelect.addEventListener("change",()=>braceletOptions.style.display=productTypeSelect.value==="bracelet"?"block":"none");

productForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const type=productTypeSelect.value;
  const name=document.getElementById("productName").value.trim();
  const size=document.getElementById("productSize").value.trim();
  const price=parseFloat(document.getElementById("productPrice").value);
  const stock=parseInt(document.getElementById("productStock").value);
  const supplier=document.getElementById("productSupplier").value.trim()||"-";
  if(!name || isNaN(price) || isNaN(stock)) return showToast("Please fill all required fields");
  const data={
    name:type==="cookie"?name:undefined,
    type:type==="bracelet"?name:undefined,
    price,stock,supplier,
    size:type==="bracelet"?size||"-":undefined,
    sku:`${type==="bracelet"?"BR":"CK"}-${crypto.randomUUID().slice(0,8).toUpperCase()}`
  };
  const col=type==="cookie"?"products_cookies":"products_bracelets";
  try{
    await addDoc(collection(db,col),data);
    showToast("✅ Product added!");
    closeModal();
    loadProducts();
  }catch{
    showToast("Failed to add");
  }
});

/* ---------- GENERATE SKUs ---------- */
document.getElementById("generateSKU").onclick=async()=>{
  const cols=["products_cookies","products_bracelets"];
  for(const c of cols){
    const snap=await getDocs(collection(db,c));
    const updates=snap.docs.map(async d=>{
      if(!d.data().sku){
        const prefix=c.includes("bracelet")?"BR":"CK";
        const sku=`${prefix}-${crypto.randomUUID().slice(0,8).toUpperCase()}`;
        return updateDoc(doc(db,c,d.id),{sku});
      }
    });
    await Promise.all(updates);
  }
  showToast("✅ SKUs generated!");
  loadProducts();
};

/* INIT */
loadOrders();
loadProducts();
</script>
</body>
</html>

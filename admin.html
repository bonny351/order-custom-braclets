<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Admin Panel ‚Äì Tactics & Treats</title>
<style>
body{font-family:"Poppins",sans-serif;background:#111;color:white;margin:0;padding:20px;}
h1,h2{text-align:center;color:#ff0000;margin-bottom:20px;}
header{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#7a0c0c,#000);padding:10px 20px;border-radius:10px;box-shadow:0 0 12px rgba(255,0,0,0.4);margin-bottom:20px;}
header img{height:60px;width:60px;border-radius:50%;border:2px solid #ff0000;background:#000;}
header h1{flex:1;text-align:center;color:#ff0000;margin:0;}
section{background:#181818;padding:20px;border-radius:12px;box-shadow:0 0 12px rgba(255,0,0,0.2);margin-bottom:30px;transition:opacity .3s;}
.tabs,.subTabs{display:flex;justify-content:center;margin-bottom:15px;gap:10px;flex-wrap:wrap;}
.tab,.subTab{padding:10px 20px;cursor:pointer;border-radius:5px;background:#222;color:#fff;font-weight:bold;transition:.2s;}
.tab.active,.subTab.active{background:#ff0000;color:#fff;box-shadow:0 0 8px #ff0000;}
.tab:hover,.subTab:hover{background:#ff4444;}
table{width:100%;border-collapse:collapse;margin-top:10px;transition:opacity 0.3s ease;}
th,td{padding:10px;border:1px solid #ff0000;text-align:center;}
th{background:#222;color:#ffb347;position:sticky;top:0;z-index:1;}
tr:nth-child(even){background:#222;}
tr:hover{background:#333;transition:.2s;}
td:focus{outline:2px solid #ff0000;background:#222;}
#searchInput{width:100%;max-width:400px;margin:10px auto;display:block;padding:8px;border-radius:5px;border:none;font-size:14px;}
button{padding:8px 12px;margin:5px;background:#ff0000;color:white;font-weight:bold;border:none;border-radius:8px;cursor:pointer;transition:.2s;}
button:hover{background:darkred;box-shadow:0 0 8px #ff0000;}
.message{color:#ffb347;font-weight:bold;text-align:center;margin-top:10px;}
.status-pending{color:#ffb347;font-weight:bold;}
.status-completed{color:#0f0;font-weight:bold;}
.status-cancelled{color:#f00;font-weight:bold;}
.recent-order{background:rgba(255,255,255,0.1)!important;}
.out-of-stock{background:rgba(255,0,0,0.2);font-weight:bold;}
.flex{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;}
select{padding:4px 6px;border-radius:5px;border:none;background:#222;color:white;}
input[type=number]{width:70px;}
label{cursor:pointer;margin-right:6px;}
span.day{display:inline-block;padding:4px 8px;margin:2px;border-radius:4px;color:white;}
span.scheduled{background:red;}
span.unscheduled{background:#444;}
.loadingOverlay {
  position:absolute;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  justify-content:center;
  align-items:center;
  color:#ffb347;
  font-weight:bold;
  font-size:20px;
  border-radius:12px;
  z-index:2;
  opacity:0;
  transition:opacity .3s;
  pointer-events:none;
}
.loadingOverlay.show {
  opacity:1;
  pointer-events:auto;
}
.addRow input{background:#222;color:white;border:1px solid #ff0000;border-radius:5px;padding:4px;text-align:center;}
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="Tactics & Treats Logo">
  <h1>Tactics & Treats Admin Panel</h1>
</header>

<div class="tabs" id="mainTabs"></div>
<div class="subTabs" id="collectionTabs"></div>

<section id="tableSection" style="position:relative;">
  <h2 id="tableTitle">Loading...</h2>
  <p id="orderCount" class="message"></p>
  <input type="text" id="searchInput" placeholder="üîç Search...">
  <p id="tableMsg" class="message"></p>
  <div class="loadingOverlay" id="loadingOverlay">‚è≥ Loading...</div>
  <table id="dynamicTable"></table>
  <div id="actionButtons" class="flex"></div>

  <hr style="border-color:#ff4444;">
  <button id="toggleMaintenanceBtn">‚ö†Ô∏è Toggle Under Construction</button>
  <button id="printCardsBtn">üñ® Print Business Cards</button>
  <p id="maintenanceMsg" class="message"></p>
</section>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {getFirestore,collection,getDocs,doc,setDoc,deleteDoc,getDoc} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",authDomain:"bracelets-and-color.firebaseapp.com",projectId:"bracelets-and-color",storageBucket:"bracelets-and-color.appspot.com",messagingSenderId:"382292570673",appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

function convertFirestoreTimestamp(ts){
  if(ts&&typeof ts==="object"&&"seconds"in ts&&"nanoseconds"in ts){
    const ms=ts.seconds*1000+ts.nanoseconds/1e6;
    return new Date(ms).toLocaleString();
  }
  return ts;
}

const allCollections={
  "Products":["products","products_bracelets","products_cookies","products_spirit"],
  "Orders":["braceletOrders","cookieOrders","spiritOrders"],
  "Users":["users","activityLogs"],
  "Settings":["_meta","metadata","siteSettings","adminSettings","colors","braceletColors"]
};

const mainTabsDiv=document.getElementById("mainTabs");
const collectionTabsDiv=document.getElementById("collectionTabs");
const tableTitle=document.getElementById("tableTitle");
const dynamicTable=document.getElementById("dynamicTable");
const searchInput=document.getElementById("searchInput");
const tableMsg=document.getElementById("tableMsg");
const actionButtonsDiv=document.getElementById("actionButtons");
const toggleBtn=document.getElementById("toggleMaintenanceBtn");
const maintenanceMsg=document.getElementById("maintenanceMsg");
const printBtn=document.getElementById("printCardsBtn");
const loadingOverlay=document.getElementById("loadingOverlay");
const orderCountMsg=document.getElementById("orderCount");

let currentCategory="";let currentCollection="";
const maintenanceDoc=doc(db,"siteSettings","maintenance");

// Tabs
Object.keys(allCollections).forEach(cat=>{
  const tab=document.createElement("div");
  tab.className="tab";
  tab.textContent=cat;
  tab.addEventListener("click",()=>{
    currentCategory=cat;
    [...mainTabsDiv.children].forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    loadCollectionTabs();
  });
  mainTabsDiv.appendChild(tab);
});
mainTabsDiv.children[0].click();

function loadCollectionTabs(){
  collectionTabsDiv.innerHTML="";
  allCollections[currentCategory].forEach(coll=>{
    const subTab=document.createElement("div");
    subTab.className="subTab";
    subTab.textContent=coll;
    subTab.addEventListener("click",()=>{
      currentCollection=coll;
      [...collectionTabsDiv.children].forEach(t=>t.classList.remove("active"));
      subTab.classList.add("active");
      loadTable();
    });
    collectionTabsDiv.appendChild(subTab);
  });
  collectionTabsDiv.children[0].click();
}

toggleBtn.addEventListener("click",async()=>{
  const docSnap=await getDoc(maintenanceDoc);
  const current=docSnap.exists()?docSnap.data().enabled:false;
  await setDoc(maintenanceDoc,{enabled:!current},{merge:true});
  maintenanceMsg.textContent=!current?"üõ†Ô∏è Site is UNDER CONSTRUCTION":"‚úÖ Site is LIVE";
});

printBtn.addEventListener("click",()=>{
  const pdfURL="Tactics & Treats.pdf";
  const win=window.open(pdfURL,"_blank");
  if(!win){alert("Please allow popups.");return;}
  win.onload=()=>win.print();
});

async function getTotalOrderCount(){
  const orderCollections=["braceletOrders","cookieOrders","spiritOrders"];
  let total=0;
  for(const collName of orderCollections){
    const snap=await getDocs(collection(db,collName));
    total+=snap.size;
  }
  return total;
}

async function loadTable(){
  const scrollY=window.scrollY;
  dynamicTable.style.minHeight=dynamicTable.offsetHeight+"px";
  loadingOverlay.classList.add("show");
  tableTitle.textContent=currentCollection;
  const snap=await getDocs(collection(db,currentCollection));

  if(currentCategory==="Orders"){
    orderCountMsg.textContent=`üì¶ Total Orders: ${snap.size}`;
  }else if(currentCategory==="Settings" && ["_meta","metadata","siteSettings","adminSettings"].includes(currentCollection)){
    const totalOrders=await getTotalOrderCount();
    orderCountMsg.textContent=`üìä Total Orders Across All Collections: ${totalOrders}`;
  }else{
    orderCountMsg.textContent="";
  }

  dynamicTable.innerHTML="";
  const keysSet=new Set();
  snap.forEach(d=>Object.keys(d.data()).forEach(k=>keysSet.add(k)));
  const keys=Array.from(keysSet);
  const headerRow=dynamicTable.insertRow();
  headerRow.insertCell(0).textContent="ID";
  keys.forEach(k=>{const th=document.createElement("th");th.textContent=k;headerRow.appendChild(th);});

  for(const docSnap of snap.docs){
    const data=docSnap.data();
    const row=dynamicTable.insertRow();
    row.dataset.id=docSnap.id;
    row.insertCell(0).textContent=docSnap.id;
    keys.forEach(key=>{
      const cell=row.insertCell();
      let value=data[key]??"";
      if(value&&typeof value==="object"&&"seconds"in value)value=convertFirestoreTimestamp(value);
      else if(Array.isArray(value))value=value.join(",");
      else if(typeof value==="object"&&value!==null)value=JSON.stringify(value);
      cell.textContent=value;
      cell.contentEditable=true;
      cell.addEventListener("blur",async()=>{
        try{
          await setDoc(doc(db,currentCollection,row.dataset.id),{...data,[key]:cell.textContent.trim()});
          tableMsg.textContent=`‚úÖ ${key} updated!`;
        }catch(e){console.error(e);}
      });
    });
  }

  // ‚ûï Add New Product Row
  if(currentCategory==="Products"){
    const addRow=dynamicTable.insertRow();
    addRow.classList.add("addRow");
    const idCell=addRow.insertCell(0);
    idCell.textContent="üÜï New";
    const inputCells={};
    keys.forEach(key=>{
      const cell=addRow.insertCell();
      const input=document.createElement("input");
      input.placeholder=key;
      input.style.width="95%";
      inputCells[key]=input;
      cell.appendChild(input);
    });
    const addBtnCell=addRow.insertCell();
    const addBtn=document.createElement("button");
    addBtn.textContent="‚ûï Add Product";
    addBtn.addEventListener("click",async()=>{
      const newData={};
      keys.forEach(k=>{
        const val=inputCells[k].value.trim();
        if(val!=="")newData[k]=isNaN(val)?val:Number(val);
      });
      if(Object.keys(newData).length===0){alert("‚ö†Ô∏è Please enter at least one value!");return;}
      try{
        const newDoc=doc(collection(db,currentCollection));
        await setDoc(newDoc,newData);
        alert("‚úÖ New product added!");
        loadTable();
      }catch(err){console.error(err);alert("‚ùå Error adding product.");}
    });
    addBtnCell.appendChild(addBtn);
  }

  // üóë Delete Selected + üìã Copy Selected
  if(currentCategory==="Orders"||currentCategory==="Products"){
    const checkboxTh=document.createElement("th");
    checkboxTh.textContent="Select";
    dynamicTable.rows[0].insertBefore(checkboxTh,dynamicTable.rows[0].cells[0]);

    [...dynamicTable.rows].slice(1).forEach(row=>{
      const selectCell=row.insertCell(0);
      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.classList.add("rowCheckbox");
      selectCell.appendChild(cb);
    });

    // DELETE BUTTON
    const delBtn=document.createElement("button");
    delBtn.textContent=currentCategory==="Orders"?"üóë Delete Selected Orders":"üóë Delete Selected Products";
    delBtn.addEventListener("click",async()=>{
      const selectedRows=[...dynamicTable.rows].slice(1).filter(r=>r.querySelector(".rowCheckbox").checked);
      if(selectedRows.length===0){alert("No items selected.");return;}
      if(!confirm(`‚ö†Ô∏è Delete ${selectedRows.length} item(s)?`))return;

      for(const row of selectedRows){
        try{await deleteDoc(doc(db,currentCollection,row.dataset.id));}catch(err){console.error(err);}
      }

      alert(`‚úÖ Deleted ${selectedRows.length} item(s).`);
      loadTable();
    });

    // COPY BUTTON
    const copyBtn=document.createElement("button");
    copyBtn.textContent="üìã Copy Selected";
    copyBtn.addEventListener("click",()=>{
      const selectedRows=[...dynamicTable.rows].slice(1).filter(r=>r.querySelector(".rowCheckbox").checked);

      if(selectedRows.length===0){alert("No items selected.");return;}

      const output=[];
      selectedRows.forEach(row=>{
        const obj={id:row.dataset.id};
        [...row.cells].slice(2).forEach((cell,i)=>{
          obj[keys[i]]=cell.textContent.trim();
        });
        output.push(obj);
      });

      navigator.clipboard.writeText(JSON.stringify(output,null,2));
      alert("üìã Copied to clipboard!");
    });

    actionButtonsDiv.innerHTML="";
    actionButtonsDiv.appendChild(delBtn);
    actionButtonsDiv.appendChild(copyBtn);
  }

  searchInput.oninput=()=>{
    const t=searchInput.value.toLowerCase();
    [...dynamicTable.rows].forEach((r,i)=>{
      if(i===0)return;
      r.style.display=r.textContent.toLowerCase().includes(t)?"":"none";
    });
  };

  dynamicTable.style.opacity="1";
  window.scrollTo(0,scrollY);
  dynamicTable.style.minHeight="";
  loadingOverlay.classList.remove("show");
}
</script>
</body>
</html>

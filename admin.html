<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Admin Panel – Tactics & Treats</title>
<style>
body { font-family:"Poppins",sans-serif; background:#111; color:white; margin:0; padding:20px; }
h1,h2 { text-align:center; color:#ff0000; margin-bottom:20px; }
section { background:#181818; padding:20px; border-radius:12px; box-shadow:0 0 12px rgba(255,0,0,0.2); margin-bottom:30px; transition:opacity 0.3s; }
.tabs, .subTabs { display:flex; justify-content:center; margin-bottom:15px; gap:10px; flex-wrap:wrap; }
.tab, .subTab { padding:10px 20px; cursor:pointer; border-radius:5px; background:#222; color:#fff; font-weight:bold; transition:0.2s; }
.tab.active, .subTab.active { background:#ff0000; color:#fff; box-shadow:0 0 8px #ff0000; }
.tab:hover, .subTab:hover { background:#ff4444; }
table { width:100%; border-collapse:collapse; margin-top:10px; display:block; overflow-x:auto; white-space:nowrap; }
th,td { padding:10px; border:1px solid #ff0000; text-align:center; }
th { background:#222; color:#ffb347; position:sticky; top:0; z-index:1; }
tr:nth-child(even) { background:#222; }
tr:hover { background:#333; transition:0.2s; }
td:focus { outline:2px solid #ff0000; background:#222; }
#searchInput { width:100%; max-width:400px; margin:10px auto; display:block; padding:8px; border-radius:5px; border:none; font-size:14px; }
button { padding:8px 12px; margin:5px; background:#ff0000; color:white; font-weight:bold; border:none; border-radius:8px; cursor:pointer; transition:0.2s; }
button:hover { background:darkred; box-shadow:0 0 8px #ff0000; }
.message { color:#ffb347; font-weight:bold; text-align:center; margin-top:10px;}
</style>
</head>
<body>

<h1>Dynamic Admin Panel – Tactics & Treats</h1>

<div class="tabs" id="mainTabs"></div>
<div class="subTabs" id="collectionTabs"></div>

<section id="tableSection">
<h2 id="tableTitle">Loading...</h2>
<input type="text" id="searchInput" placeholder="🔍 Search...">
<p id="tableMsg" class="message"></p>
<table id="dynamicTable"></table>
<div id="actionButtons" class="flex"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ---------- Firebase ----------
const firebaseConfig = {
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- Collections ----------
const allCollections = {
  "Products": ["products", "products_bracelets", "products_cookies", "products_spirit"],
  "Orders": ["braceletOrders", "cookieOrders", "spiritOrders"],
  "Users": ["users", "activityLogs"],
  "Settings": ["_meta", "metadata", "siteSettings", "adminSettings", "colors", "braceletColors"]
};

// ---------- DOM ----------
const mainTabsDiv = document.getElementById("mainTabs");
const collectionTabsDiv = document.getElementById("collectionTabs");
const tableSection = document.getElementById("tableSection");
const tableTitle = document.getElementById("tableTitle");
const dynamicTable = document.getElementById("dynamicTable");
const searchInput = document.getElementById("searchInput");
const tableMsg = document.getElementById("tableMsg");
const actionButtonsDiv = document.getElementById("actionButtons");

let currentCategory = "";
let currentCollection = "";

// ---------- Tabs ----------
Object.keys(allCollections).forEach(cat=>{
  const tab = document.createElement("div");
  tab.className="tab";
  tab.textContent=cat;
  tab.addEventListener("click",()=>{
    currentCategory=cat;
    [...mainTabsDiv.children].forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    loadCollectionTabs();
  });
  mainTabsDiv.appendChild(tab);
});

// Select first category by default
mainTabsDiv.children[0].click();

// ---------- Sub-tabs ----------
function loadCollectionTabs(){
  collectionTabsDiv.innerHTML="";
  allCollections[currentCategory].forEach(coll=>{
    const subTab = document.createElement("div");
    subTab.className="subTab";
    subTab.textContent=coll;
    subTab.addEventListener("click",()=>{
      currentCollection=coll;
      [...collectionTabsDiv.children].forEach(t=>t.classList.remove("active"));
      subTab.classList.add("active");
      loadTable();
    });
    collectionTabsDiv.appendChild(subTab);
  });
  collectionTabsDiv.children[0].click();
}

// ---------- Load Table ----------
async function loadTable(){
  tableTitle.textContent=currentCollection;
  tableMsg.textContent="⏳ Loading...";
  dynamicTable.innerHTML="";
  actionButtonsDiv.innerHTML="";

  const snap = await getDocs(collection(db, currentCollection));
  if(snap.empty){ tableMsg.textContent="No documents found"; return; }
  tableMsg.textContent="";

  // Get all keys dynamically
  const keysSet = new Set();
  snap.forEach(docSnap=>{
    Object.keys(docSnap.data()).forEach(k=>keysSet.add(k));
  });
  const keys = Array.from(keysSet);
  
  // Table header
  const thead = dynamicTable.insertRow();
  thead.insertCell(0).textContent="ID";
  keys.forEach(k=>{
    const th = document.createElement("th");
    th.textContent=k;
    thead.appendChild(th);
  });

  // Table rows
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    const row = dynamicTable.insertRow();
    row.dataset.id = docSnap.id;
    row.insertCell(0).textContent = docSnap.id;

    keys.forEach(key=>{
      const cell = row.insertCell();
      let value = data[key];
      if(Array.isArray(value)) value = value.join(",");
      else if(typeof value === "object" && value!==null) value = JSON.stringify(value);
      cell.textContent=value;
      cell.contentEditable=true;

      // Save on blur
      cell.addEventListener("blur", async ()=>{
        let newValue = cell.textContent.trim();
        if(typeof data[key] === "number") newValue = parseFloat(newValue) || 0;
        else if(Array.isArray(data[key])) newValue = newValue.split(",").map(s=>s.trim()).filter(s=>s);
        else if(typeof data[key] === "object" && data[key]!==null){
          try{ newValue = JSON.parse(newValue); } catch(e){ newValue = data[key]; }
        }
        try{
          await setDoc(doc(db, currentCollection, row.dataset.id), {...data, [key]:newValue});
          tableMsg.textContent=`✅ ${key} updated!`;
        }catch(err){ console.error(err); tableMsg.textContent=`❌ Error updating ${key}`; }
      });
    });
  });

  // Add "Add" and "Delete" buttons for collections except Orders
  if(!currentCategory.includes("Orders")){
    const addBtn = document.createElement("button");
    addBtn.textContent="➕ Add Document";
    addBtn.addEventListener("click", async ()=>{
      const newId = prompt("Enter new document ID:");
      if(!newId) return;
      try{
        await setDoc(doc(db,currentCollection,newId), {});
        loadTable();
      }catch(e){console.error(e); tableMsg.textContent="❌ Error adding document";}
    });
    const delBtn = document.createElement("button");
    delBtn.textContent="🗑 Delete Document";
    delBtn.addEventListener("click", async ()=>{
      const delId = prompt("Enter document ID to delete:");
      if(!delId) return;
      if(!confirm("⚠️ Are you sure?")) return;
      try{
        await deleteDoc(doc(db,currentCollection,delId));
        loadTable();
      }catch(e){console.error(e); tableMsg.textContent="❌ Error deleting document";}
    });
    actionButtonsDiv.appendChild(addBtn);
    actionButtonsDiv.appendChild(delBtn);
  }

  // Search/filter
  searchInput.addEventListener("input", ()=>{
    const term = searchInput.value.toLowerCase();
    [...dynamicTable.rows].forEach((row,i)=>{
      if(i===0) return;
      row.style.display = row.textContent.toLowerCase().includes(term) ? "" : "none";
    });
  });
}
</script>
</body>
</html>

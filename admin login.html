<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bracelet Admin Panel</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain: "bracelets-and-color.firebaseapp.com",
  projectId: "bracelets-and-color",
  storageBucket: "bracelets-and-color.firebasestorage.app",
  messagingSenderId: "382292570673",
  appId: "1:382292570673:web:1c966e2e7e8fc2efa31b10",
  measurementId: "G-BJPQN6S7YB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- Default data ---
const defaultColors = ["Red", "Black", "Navy Blue", "Green", "Camo"];
const defaultOrders = [
  { name: "Sample User 1", email: "sample1@example.com", type: "Cobra", color1:"Red", color2:"Black", size:"7\"", extrasCount:0, extrasDesc:"", price:5.00, status:"Pending", adminNotes:"Sample order", createdAt:serverTimestamp() },
  { name: "Sample User 2", email: "sample2@example.com", type: "Fishtail", color1:"Green", color2:"Camo", size:"8\"", extrasCount:1, extrasDesc:"Glow Buckle", price:6.50, status:"Pending", adminNotes:"Sample order", createdAt:serverTimestamp() },
  { name: "Sample User 3", email: "sample3@example.com", type: "King Cobra", color1:"Navy Blue", color2:"Red", size:"6\"", extrasCount:2, extrasDesc:"Glow Buckle, Name Tag", price:7.25, status:"Pending", adminNotes:"Sample order", createdAt:serverTimestamp() }
];

// --- UI Elements ---
let progressBar, statusLog, usersTableBody;

// --- Helpers ---
function logStatus(message) {
  const p = document.createElement("p");
  p.innerText = message;
  statusLog.appendChild(p);
  statusLog.scrollTop = statusLog.scrollHeight;
}

function updateProgress(percent) {
  progressBar.style.width = percent + "%";
  progressBar.innerText = percent + "%";
}

// --- Firebase Setup Functions ---
async function setupColors() {
  logStatus("Starting color setup...");
  try {
    const colRef = collection(db, "braceletColors");
    const snapshot = await getDocs(colRef);
    if (snapshot.empty) {
      for (let i = 0; i < defaultColors.length; i++) {
        const color = defaultColors[i];
        logStatus(`Creating color: ${color}`);
        await addDoc(colRef, { name: color, addedAt: serverTimestamp() });
        updateProgress(Math.round(((i+1)/defaultColors.length)*50));
      }
      logStatus("âœ… Default colors added successfully!");
    } else {
      logStatus("âš  braceletColors already exists.");
      updateProgress(50);
    }
  } catch (err) {
    console.error(err);
    logStatus("âŒ Failed to create colors.");
  }
}

async function setupOrders() {
  logStatus("Starting sample orders...");
  try {
    const orderRef = collection(db, "braceletOrders");
    const snapshot = await getDocs(orderRef);
    if (snapshot.empty) {
      for (let i = 0; i < defaultOrders.length; i++) {
        const order = defaultOrders[i];
        logStatus(`Creating sample order: ${order.name}`);
        await addDoc(orderRef, order);
        updateProgress(50 + Math.round(((i+1)/defaultOrders.length)*50));
      }
      logStatus("âœ… Sample orders added successfully!");
    } else {
      logStatus("âš  braceletOrders already exists.");
      updateProgress(100);
    }
  } catch(err){
    console.error(err);
    logStatus("âŒ Failed to create orders.");
  }
}

async function runFullSetup() {
  statusLog.innerHTML = "";
  updateProgress(0);
  await setupColors();
  await setupOrders();
  updateProgress(100);
  logStatus("ðŸŽ‰ Firebase setup complete!");
}

// --- Admin User Management ---
async function loadUsers() {
  usersTableBody.innerHTML = "";
  const snapshot = await getDocs(collection(db, "users"));
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${data.displayName || data.email}</td>
      <td>${data.email}</td>
      <td>
        <input type="checkbox" ${data.admin ? "checked" : ""} onchange="toggleAdmin('${docSnap.id}', this.checked)">
      </td>
    `;
    usersTableBody.appendChild(row);
  });
}

window.toggleAdmin = async (uid, isAdmin) => {
  const userRef = doc(db, "users", uid);
  await updateDoc(userRef, { admin: isAdmin });
};

// --- Authentication ---
async function login(email, password){
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch(err){
    alert("Login failed: "+err.message);
  }
}

async function logout() {
  await signOut(auth);
}

onAuthStateChanged(auth, async user=>{
  if(user){
    const userDoc = await getDoc(doc(db,"users",user.uid));
    if(userDoc.exists() && userDoc.data().admin){
      document.getElementById("loginDiv").style.display="none";
      document.getElementById("adminDiv").style.display="block";
      loadUsers();
    } else {
      alert("You are not an admin!");
      logout();
    }
  } else {
    document.getElementById("loginDiv").style.display="block";
    document.getElementById("adminDiv").style.display="none";
  }
});
</script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
  <!-- Login -->
  <div id="loginDiv" class="max-w-md mx-auto">
    <h2 class="text-xl font-bold mb-4">Admin Login</h2>
    <input id="email" type="email" placeholder="Email" class="w-full mb-2 p-2 rounded border">
    <input id="password" type="password" placeholder="Password" class="w-full mb-2 p-2 rounded border">
    <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="login(email.value, password.value)">Login</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminDiv" class="hidden max-w-4xl mx-auto">
    <h2 class="text-xl font-bold mb-4">Firebase Setup & User Management</h2>
    <button class="bg-green-500 text-white px-4 py-2 rounded mb-4" onclick="runFullSetup()">ðŸš€ Run Full Setup</button>
    <div class="w-full bg-gray-300 h-6 rounded mb-2 overflow-hidden">
      <div id="progressBar" class="h-full bg-green-500 text-white text-center font-bold transition-all duration-300" style="width:0%">0%</div>
    </div>
    <div id="statusLog" class="bg-white p-4 rounded h-64 overflow-y-auto text-gray-800 shadow-inner mb-6"></div>

    <h2 class="text-xl font-bold mb-2">User Management</h2>
    <table class="w-full bg-white shadow rounded overflow-hidden text-sm mb-4">
      <thead class="bg-gray-200">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Admin</th>
        </tr>
      </thead>
      <tbody id="usersTableBody"></tbody>
    </table>
    <button class="bg-red-500 text-white px-4 py-2 rounded" onclick="logout()">Logout</button>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactics & Treats â€“ Admin Panel</title>

<style>
body{font-family:"Poppins",sans-serif;background:#111;color:white;margin:0;padding:20px;}
h1,h2{text-align:center;color:#ff0000;}
header{display:flex;justify-content:center;align-items:center;background:linear-gradient(90deg,#7a0c0c,#000);padding:15px;border-radius:10px;box-shadow:0 0 12px red;margin-bottom:20px;}
.tabs,.subTabs{display:flex;justify-content:center;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
.tab,.subTab{padding:10px 20px;background:#222;border-radius:6px;cursor:pointer;font-weight:bold;}
.tab.active,.subTab.active{background:#ff0000;box-shadow:0 0 8px red;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{padding:10px;border:1px solid #ff0000;text-align:center;}
tr:nth-child(even){background:#222;}
.statusSelect{padding:5px;background:#222;color:white;border:1px solid #ff0000;border-radius:6px;}
.paidRow{background:rgba(0,255,0,0.25)!important;}
.unpaidRow{background:rgba(255,0,0,0.25)!important;}
.pendingRow{background:rgba(255,255,0,0.25)!important;}
.lateRow{outline:2px solid orange;}
.actionBar{display:flex;justify-content:center;gap:10px;margin-top:15px;}
.actionBar button{background:#ff0000;border:none;padding:10px 14px;border-radius:6px;font-weight:bold;cursor:pointer;}
.actionBar button:hover{background:#cc0000;box-shadow:0 0 10px red;}
.summaryBar{background:#222;border-radius:10px;margin-top:10px;padding:10px;text-align:center;font-weight:bold;color:#ffb347;}
#detailsModal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:1000;}
#detailsBox{background:#181818;padding:20px;border-radius:12px;width:90%;max-width:450px;box-shadow:0 0 10px red;}
.closeBtn{float:right;font-size:20px;color:#ff4444;cursor:pointer;}
#printArea{display:none;background:white;color:black;padding:20px;}
#dashboard{display:none;background:#181818;padding:20px;margin-top:20px;border-radius:12px;box-shadow:0 0 12px red;}
.chartBox{background:#222;padding:10px;border-radius:12px;margin-top:20px;}
</style>
</head>

<body>

<header><h1>Tactics & Treats Admin Panel</h1></header>

<div class="tabs" id="mainTabs"></div>
<div class="subTabs" id="subTabs"></div>

<section>
  <h2 id="tableTitle">Loading...</h2>

  <input id="searchInput" type="text" placeholder="ðŸ”Ž Searchâ€¦" 
         style="display:block;margin:auto;width:90%;max-width:400px;">

  <div class="actionBar">
    <button id="deleteSelected">ðŸ—‘ Delete</button>
    <button id="copySelected">ðŸ“‹ Copy</button>
    <button id="exportCSV">ðŸ“¥ Export CSV</button>
    <button id="sortUnpaid">â¬† Unpaid First</button>
    <button id="openDashboard">ðŸ“Š Dashboard</button>
  </div>

  <p id="tableMsg" style="text-align:center;"></p>

  <table id="dynamicTable"></table>

  <div id="summaryBar" class="summaryBar"></div>
</section>

<!-- Details Modal -->
<div id="detailsModal">
  <div id="detailsBox">
    <span class="closeBtn" onclick="closeDetails()">âœ–</span>
    <h2>Order Details</h2>
    <div id="detailsContent"></div>
    <br>
    <button onclick="printOrder()">ðŸ–¨ Print</button>
    <button onclick="sendSMS()">ðŸ“² SMS</button>
  </div>
</div>

<div id="printArea"></div>

<div id="dashboard">
  <h2>ðŸ“Š Dashboard</h2>
  <div id="dashTotals"></div>

  <div class="chartBox"><canvas id="chartStatus"></canvas></div>
  <div class="chartBox"><canvas id="chartProfit"></canvas></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {getFirestore,collection,getDocs,doc,setDoc,deleteDoc} 
from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* Main Tabs */
const collections={
  "Products":["products","products_bracelets","products_cookies","products_spirit"],
  "Orders":["braceletOrders","cookieOrders","spiritOrders"],
  "Users":["users"],
  "Settings":["siteSettings"]
};

const mainTabs=document.getElementById("mainTabs");
const subTabs=document.getElementById("subTabs");
const table=document.getElementById("dynamicTable");
const summaryBar=document.getElementById("summaryBar");
const msg=document.getElementById("tableMsg");
const dashboard=document.getElementById("dashboard");

let currentCollection="", allOrders=[];

/* Build Main Tabs */
Object.keys(collections).forEach(cat=>{
  const t=document.createElement("div");
  t.className="tab"; t.textContent=cat;
  t.onclick=()=>{
    [...mainTabs.children].forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    loadSubTabs(cat);
  };
  mainTabs.appendChild(t);
});
mainTabs.children[0].click();

/* Build Sub Tabs */
function loadSubTabs(cat){
  subTabs.innerHTML="";
  collections[cat].forEach(sub=>{
    const st=document.createElement("div");
    st.className="subTab"; st.textContent=sub;
    st.onclick=()=>{
      [...subTabs.children].forEach(x=>x.classList.remove("active"));
      st.classList.add("active");
      loadTable(sub);
    };
    subTabs.appendChild(st);
  });
  subTabs.children[0].click();
}

/* Color rows */
function colorRow(row,status,date){
  row.classList.remove("paidRow","unpaidRow","pendingRow","lateRow");

  if(status.includes("Paid")) row.classList.add("paidRow");
  else if(status==="Pending") row.classList.add("pendingRow");
  else if(status==="Unpaid") row.classList.add("unpaidRow");

  if(date){
    const age=(Date.now()-new Date(date))/86400000;
    if(age>5 && !status.includes("Paid")) row.classList.add("lateRow");
  }
}

/* Status dropdown */
function statusDropdown(row,data,id){
  const s=document.createElement("select");
  s.className="statusSelect";

  ["Paid in Cash","Paid by Card","Pending","Unpaid"].forEach(st=>{
    const o=new Option(st,st);
    if(data.status===st) o.selected=true;
    s.add(o);
  });

  colorRow(row,data.status,data.createdAt);

  s.onchange=async()=>{
    data.status=s.value;
    colorRow(row,s.value,data.createdAt);
    await setDoc(doc(db,currentCollection,id),data);
  };

  return s;
}

/* Load table */
async function loadTable(col){
  currentCollection=col;
  document.getElementById("tableTitle").textContent=col;
  table.innerHTML="";

  const snap=await getDocs(collection(db,col));
  const docs=snap.docs;

  allOrders=docs.map(d=>({...d.data(),id:d.id}));

  if(!docs.length){ table.innerHTML="<tr><td>No Data</td></tr>"; return; }

  const keys=new Set(["status"]);
  docs.forEach(d=>Object.keys(d.data()).forEach(k=>keys.add(k)));
  const keyList=[...keys];

  const header=table.insertRow();
  header.insertCell().textContent="Select";
  header.insertCell().textContent="Status";
  header.insertCell().textContent="Details";
  keyList.forEach(k=>header.insertCell().textContent=k);

  docs.forEach(docSnap=>{
    const data=docSnap.data(), id=docSnap.id;
    const row=table.insertRow();

    /* checkbox */
    row.insertCell().innerHTML=`<input type="checkbox" class="cb" data-id="${id}">`;

    /* status */
    row.insertCell().appendChild(statusDropdown(row,data,id));

    /* details */
    row.insertCell().innerHTML=`<button onclick="openDetails('${id}')">ðŸ“„</button>`;

    /* fields */
    keyList.forEach(k=>{
      const c=row.insertCell();
      c.textContent=data[k] ?? "";
      c.contentEditable=true;

      c.onblur=()=>{
        data[k]=c.textContent.trim();
        setDoc(doc(db,col,id),data);
      };
    });

    colorRow(row,data.status,data.createdAt);
  });

  updateSummary();
}

/* Summary + Profit */
function updateSummary(){
  const rows=[...table.rows].slice(1);
  let paid=0,unpaid=0,pending=0,totalProfit=0;

  rows.forEach(r=>{
    const status=r.cells[1].innerText;
    const price=parseFloat(r.cells[r.cells.length-1].innerText)||0;
    const cost=price/2;
    const profit=price-cost;

    if(status.includes("Paid")){paid++; totalProfit+=profit;}
    else if(status==="Pending") pending++;
    else if(status==="Unpaid") unpaid++;
  });

  summaryBar.innerHTML=
  `Total: ${rows.length} | Paid: ${paid} | Pending: ${pending} | Unpaid: ${unpaid} | Profit: $${totalProfit.toFixed(2)}`;
}

/* Delete */
deleteSelected.onclick=async()=>{
  const selected=[...document.querySelectorAll(".cb:checked")];
  if(!selected.length)return alert("Nothing selected!");
  if(!confirm("Delete selected orders?"))return;

  for(const cb of selected)
    await deleteDoc(doc(db,currentCollection,cb.dataset.id));

  loadTable(currentCollection);
};

/* Copy */
copySelected.onclick=()=>{
  const selected=[...document.querySelectorAll(".cb:checked")];
  const rows=selected.map(cb=>{
    const r=cb.parentElement.parentElement;
    return [...r.cells].map(c=>c.innerText);
  });
  navigator.clipboard.writeText(JSON.stringify(rows,null,2));
  alert("Copied!");
};

/* Export CSV */
exportCSV.onclick=()=>{
  let csv="";
  [...table.rows].forEach(r=>{
    const cols=[...r.cells].map(c=>c.innerText.replace(/,/g,";"));
    csv+=cols.join(",")+"\n";
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=currentCollection+".csv";
  a.click();
};

/* Sort unpaid */
sortUnpaid.onclick=()=>{
  const rows=[...table.rows].slice(1);
  rows.sort((a,b)=>{
    const A=a.cells[1].innerText, B=b.cells[1].innerText;
    const order={"Unpaid":0,"Pending":1,"Paid in Cash":2,"Paid by Card":2};
    return order[A]-order[B];
  });
  rows.forEach(r=>table.appendChild(r));
};

/* Search */
searchInput.oninput=()=>{
  const t=searchInput.value.toLowerCase();
  [...table.rows].forEach((r,i)=>{
    if(i===0)return;
    r.style.display=r.innerText.toLowerCase().includes(t)?"":"none";
  });
};

/* DETAILS POPUP */
window.openDetails=(id)=>{
  const o=allOrders.find(x=>x.id===id);
  window.currentOrder=o;

  let html="";
  Object.keys(o).forEach(k=>html+=`<p><b>${k}:</b> ${o[k]}</p>`);

  document.getElementById("detailsContent").innerHTML=html;
  document.getElementById("detailsModal").style.display="flex";
};

window.closeDetails=()=>{
  document.getElementById("detailsModal").style.display="none";
};

/* PRINT */
window.printOrder=()=>{
  const o=window.currentOrder;
  let html="<h2>Tactics & Treats Receipt</h2>";
  Object.keys(o).forEach(k=>html+=`<p><b>${k}:</b> ${o[k]}</p>`);
  const area=document.getElementById("printArea");
  area.innerHTML=html;
  area.style.display="block";
  window.print();
  area.style.display="none";
};

/* SMS */
window.sendSMS=()=>{
  const o=window.currentOrder;
  const num=o.phone||o.Phone||"";
  const msg=encodeURIComponent("Your Tactics & Treats order update: "+o.status);
  window.location.href=`sms:${num}?body=${msg}`;
};

/* DASHBOARD */
openDashboard.onclick=()=>{
  dashboard.style.display=dashboard.style.display==="none"?"block":"none";
  buildDashboard();
};

function buildDashboard(){
  const paid=allOrders.filter(o=>o.status?.includes("Paid"));
  const unpaid=allOrders.filter(o=>o.status==="Unpaid");
  const pending=allOrders.filter(o=>o.status==="Pending");

  const profits=paid.map(o=>{
    const price=parseFloat(o.total)||0;
    return price-(price/2);
  });

  document.getElementById("dashTotals").innerHTML=
  `<p>Paid: ${paid.length}</p>
   <p>Pending: ${pending.length}</p>
   <p>Unpaid: ${unpaid.length}</p>
   <p>Total Profit: $${profits.reduce((a,b)=>a+b,0).toFixed(2)}</p>`;

  new Chart(document.getElementById("chartStatus"),{
    type:"pie",
    data:{labels:["Paid","Pending","Unpaid"],
    datasets:[{data:[paid.length,pending.length,unpaid.length],backgroundColor:["green","yellow","red"]}]}
  });

  new Chart(document.getElementById("chartProfit"),{
    type:"bar",
    data:{labels:["Profit"],
    datasets:[{data:[profits.reduce((a,b)=>a+b,0)],backgroundColor:"orange"}]}
  });
}
</script>
</body>
</html>

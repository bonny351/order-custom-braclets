<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bracelets – Tactics & Treats Preorder</title>
<style>
body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(to right, #7a0c0c, #000, #7a0c0c);
  color: white;
  margin: 0;
  padding: 20px;
}
nav {
  text-align: center;
  background: #111;
  padding: 10px 0;
  border-bottom: 2px solid #ff0000;
  box-shadow: 0 0 10px #ff0000;
}
nav a {
  color: white;
  margin: 0 15px;
  font-weight: bold;
  text-decoration: none;
  transition: 0.2s;
}
nav a:hover {
  color: #ff0000;
  text-shadow: 0 0 6px #ff0000;
}
h1 {
  text-align: center;
  color: #ff0000;
  margin-bottom: 30px;
}
form {
  background: #111;
  border-radius: 16px;
  padding: 20px;
  margin: 20px auto;
  max-width: 500px;
  box-shadow: 0 0 15px #ff0000;
}
label {
  display: block;
  margin-top: 10px;
  font-weight: 500;
  color: white;
}
input, select {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: none;
  margin-top: 5px;
  font-size: 14px;
}
select:disabled {
  background: #555;
  color: #aaa;
  cursor: not-allowed;
}
button {
  margin-top: 20px;
  padding: 12px;
  border: none;
  background: #ff0000;
  color: #fff;
  font-weight: bold;
  border-radius: 8px;
  cursor: pointer;
  width: 100%;
  transition: 0.2s;
}
button:hover {
  background: darkred;
}
.paypal-btn {
  display: inline-block;
  background: #ffc439;
  color: black;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: bold;
  text-decoration: none;
  margin-top: 15px;
  transition: 0.2s;
}
.paypal-btn:hover {
  background: #ffb347;
}
.paypal-container {
  text-align: center;
  margin-top: 20px;
  padding: 15px;
  background: #222;
  border-radius: 12px;
  box-shadow: 0 0 10px #ff0000;
}
#priceDisplay {
  margin-top: 5px;
  font-weight: bold;
  color: #ffb347;
}
</style>
</head>
<body>
<nav>
  <a href="cookies.html">Cookies</a>
  <a href="bracelets.html">Bracelets</a>
  <a href="spiritwear.html">Spirit Wear</a>
</nav>

<h1>Bracelet Preorder</h1>

<form id="braceletForm">
  <label>Name</label>
  <input id="braceletName" type="text" required />

  <label>Email</label>
  <input id="braceletEmail" type="email" required />

  <label>Choose Bracelet</label>
  <select id="braceletSelect" required></select>

  <label>Size</label>
  <select id="braceletSize" required></select>
  <p id="priceDisplay">Price: $0.00</p>

  <label>Color 1</label>
  <select id="color1" required></select>

  <label>Color 2</label>
  <select id="color2" required></select>

  <label>Clip Type</label>
  <select id="clipType" required>
    <option value="">Select Clip Type</option>
    <option value="Plastic">Plastic</option>
    <option value="Metal">Metal</option>
    <option value="Adjustable Knot">Adjustable Knot</option>
  </select>

  <label>Clip Color</label>
  <select id="clipColor" required>
    <option value="">Select Clip Color</option>
    <option value="Black">Black</option>
    <option value="Silver">Silver</option>
    <option value="Gold">Gold</option>
    <option value="Red">Red</option>
    <option value="Blue">Blue</option>
  </select>

  <label>Quantity</label>
  <input id="braceletQty" type="number" min="1" value="1" required />

  <label>Payment Method</label>
  <select id="braceletPayment">
    <option value="PayPal">PayPal</option>
    <option value="Cash">Cash</option>
  </select>

  <button type="button" id="submitBtn">Submit Bracelet Order</button>
</form>

<div id="paypalContainer" class="paypal-container" style="display:none;"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, getDoc, doc, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain: "bracelets-and-color.firebaseapp.com",
  projectId: "bracelets-and-color",
  storageBucket: "bracelets-and-color.appspot.com",
  messagingSenderId: "382292570673",
  appId: "1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const braceletSelect = document.getElementById("braceletSelect");
const sizeSelect = document.getElementById("braceletSize");
const color1Select = document.getElementById("color1");
const color2Select = document.getElementById("color2");
const clipTypeSelect = document.getElementById("clipType");
const clipColorSelect = document.getElementById("clipColor");
const paypalDiv = document.getElementById("paypalContainer");
const priceDisplay = document.getElementById("priceDisplay");
const form = document.getElementById("braceletForm");

let currentBraceletData = null;

// Load bracelets safely
async function loadBracelets() {
  try {
    const snapshot = await getDocs(collection(db, "products_bracelets"));
    braceletSelect.innerHTML = '<option value="">Select Bracelet</option>';
    sizeSelect.innerHTML = '<option value="">Select Size</option>';
    color1Select.innerHTML = '<option value="">Select Color 1</option>';
    color2Select.innerHTML = '<option value="">Select Color 2</option>';

    const colorsSet = new Set();

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const opt = document.createElement("option");
      // Show lowest price as hint
      const minPrice = typeof data.price === "object" ? Math.min(...Object.values(data.price)) : data.price;
      opt.value = docSnap.id;
      opt.textContent = data.type + " - $" + minPrice + (data.stock ? ` (${data.stock} in stock)` : " - Out of stock");
      opt.disabled = !data.stock || data.stock === 0;
      braceletSelect.appendChild(opt);

      if (data.colorOptions) {
        data.colorOptions.forEach(color => {
          if (!colorsSet.has(color)) {
            colorsSet.add(color);
            const c1 = document.createElement("option");
            c1.value = color;
            c1.textContent = color;
            color1Select.appendChild(c1);

            const c2 = document.createElement("option");
            c2.value = color;
            c2.textContent = color;
            color2Select.appendChild(c2);
          }
        });
      }
    });
  } catch (err) {
    console.error("Error loading bracelets:", err);
    alert("⚠️ Could not load bracelets. Please try again later.");
  }
}

// Populate sizes & reset price when bracelet changes
braceletSelect.addEventListener("change", async () => {
  const braceletId = braceletSelect.value;
  if (!braceletId) return;

  const docSnap = await getDoc(doc(db, "products_bracelets", braceletId));
  if (!docSnap.exists()) return;

  currentBraceletData = docSnap.data();

  // Populate size dropdown
  sizeSelect.innerHTML = '<option value="">Select Size</option>';
  currentBraceletData.sizeOptions.forEach(size => {
    const opt = document.createElement("option");
    opt.value = size;
    opt.textContent = size;
    sizeSelect.appendChild(opt);
  });

  priceDisplay.textContent = "Price: $0.00";
});

// Update price when size changes
sizeSelect.addEventListener("change", () => {
  if (!currentBraceletData) return;
  const selectedSize = sizeSelect.value;
  const price = currentBraceletData.price[selectedSize] || 0;
  priceDisplay.textContent = `Price: $${price.toFixed(2)}`;
});

// Disable clip color for certain clip types
clipTypeSelect.addEventListener("change", () => {
  const type = clipTypeSelect.value;
  if (type === "Adjustable Knot" || type === "Metal") {
    clipColorSelect.value = "";
    clipColorSelect.disabled = true;
  } else {
    clipColorSelect.disabled = false;
  }
});

// Submit order
async function submitOrder() {
  const name = document.getElementById("braceletName").value.trim();
  const email = document.getElementById("braceletEmail").value.trim();
  const braceletId = braceletSelect.value;
  const size = sizeSelect.value;
  const color1 = color1Select.value;
  const color2 = color2Select.value;
  const clipType = clipTypeSelect.value;
  const clipColor = clipColorSelect.value;
  const qty = parseInt(document.getElementById("braceletQty").value) || 1;
  const payment = document.getElementById("braceletPayment").value;

  if (!name || !email || !braceletId || !size || !color1 || !color2 || !clipType || (!clipColor && !clipColorSelect.disabled)) {
    return alert("⚠️ Please fill all fields correctly.");
  }

  if (!currentBraceletData) return alert("❌ Bracelet data not loaded.");

  const price = currentBraceletData.price[size] || 0; // price depends only on size
  const total = price * qty;

  try {
    await addDoc(collection(db, "braceletOrders"), {
      name, email, product: currentBraceletData.type, size, color1, color2,
      clipType, clipColor, qty, total, payment,
      createdAt: new Date(), status: "Pending"
    });

    if (payment === "PayPal") {
      const link = currentBraceletData.paypalLink || "#";
      paypalDiv.innerHTML = `
        <p>Order submitted! Total: $${total.toFixed(2)}</p>
        <p>${currentBraceletData.type} | Size: ${size} | Colors: ${color1}, ${color2} | Clip: ${clipType} ${clipColor ? `(${clipColor})` : ""} | Qty: ${qty}</p>
        <a href="${link}" target="_blank" class="paypal-btn">Pay with PayPal</a>
      `;
      paypalDiv.style.display = "block";
    } else {
      paypalDiv.style.display = "none";
      alert(`✅ Order submitted! Total: $${total.toFixed(2)} | Payment: Cash`);
    }

    form.reset();
    priceDisplay.textContent = "Price: $0.00";
    clipColorSelect.disabled = false;
    currentBraceletData = null;
  } catch (err) {
    console.error("Order submission failed:", err);
    alert("❌ Failed to submit order. Please try again.");
  }
}

document.getElementById("submitBtn").addEventListener("click", submitOrder);

loadBracelets();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bracelet Order</title>
  <script type="module">

    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      onSnapshot,
      increment
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- 🔥 Your Firebase Config ---
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Form Elements ---
    const knotSelect = document.getElementById("braceletType");
    const color1Select = document.getElementById("color1");
    const color2Select = document.getElementById("color2");
    const sizeSelect = document.getElementById("size");
    const stockText = document.getElementById("stock");
    const priceDisplay = document.getElementById("price");
    const orderButton = document.getElementById("orderButton");

    // --- Load Bracelet Data (colors, sizes, stock, prices) ---
    async function loadBraceletData(type) {
      if (!type) return;

      const typeKey = type.toLowerCase().replace(/\s+/g, "-"); // e.g. "King Cobra" → "king-cobra"
      const docRef = doc(db, "products_bracelets", typeKey);

      onSnapshot(docRef, (snap) => {
        if (!snap.exists()) {
          console.warn(`⚠️ No Firestore document for ${typeKey}`);
          return;
        }

        const data = snap.data();

        // --- Colors ---
        color1Select.innerHTML = "";
        color2Select.innerHTML = "";
        (data.colorOptions || []).forEach(color => {
          const opt1 = document.createElement("option");
          opt1.value = color;
          opt1.textContent = color;
          color1Select.appendChild(opt1);

          const opt2 = document.createElement("option");
          opt2.value = color;
          opt2.textContent = color;
          color2Select.appendChild(opt2);
        });

        // --- Sizes ---
        sizeSelect.innerHTML = "";
        (data.sizeOptions || []).forEach(size => {
          const opt = document.createElement("option");
          opt.value = size;
          opt.textContent = size;
          sizeSelect.appendChild(opt);
        });

        // --- Stock ---
        stockText.textContent = `In Stock: ${data.stock ?? 0}`;

        // --- Price (display smallest size as default) ---
        const prices = data.price || {};
        const firstSize = data.sizeOptions ? data.sizeOptions[0] : null;
        if (firstSize && prices[firstSize]) {
          priceDisplay.textContent = `$${prices[firstSize].toFixed(2)}`;
        }

        // Update price on size change
        sizeSelect.onchange = () => {
          const size = sizeSelect.value;
          if (prices[size]) {
            priceDisplay.textContent = `$${prices[size].toFixed(2)}`;
          }
        };
      });
    }

    // --- Subtract Stock on Order ---
    async function submitOrder() {
      const braceletType = knotSelect.value;
      const quantity = parseInt(document.getElementById("quantity").value);

      if (!braceletType || !quantity || quantity <= 0) {
        alert("Please select a bracelet type and valid quantity.");
        return;
      }

      const typeKey = braceletType.toLowerCase().replace(/\s+/g, "-");
      const braceletRef = doc(db, "products_bracelets", typeKey);
      const snap = await getDoc(braceletRef);

      if (!snap.exists()) {
        alert("Bracelet type not found in Firestore!");
        return;
      }

      const data = snap.data();
      const currentStock = data.stock || 0;

      if (currentStock < quantity) {
        alert(`Sorry, only ${currentStock} left in stock.`);
        return;
      }

      await updateDoc(braceletRef, {
        stock: increment(-quantity)
      });

      alert(`✅ Order placed! ${quantity} subtracted from stock.`);
    }

    // --- Event Listeners ---
    knotSelect.addEventListener("change", () => {
      loadBraceletData(knotSelect.value);
    });

    orderButton.addEventListener("click", submitOrder);

    // --- Initialize Default Bracelet Type ---
    window.addEventListener("DOMContentLoaded", () => {
      loadBraceletData(knotSelect.value);
    });

  </script>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f8fafc;
      color: #111;
      padding: 30px;
    }
    label { display: block; margin-top: 10px; font-weight: bold; }
    select, input, button {
      margin-top: 5px;
      padding: 8px;
      width: 100%;
      max-width: 300px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #1d4ed8; }
    .container { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div class="container">
    <h1>Bracelet Order</h1>

    <label for="braceletType">Bracelet Type:</label>
    <select id="braceletType">
      <option value="King Cobra">King Cobra</option>
      <option value="Fishtail">Fishtail</option>
      <option value="Cobra">Cobra</option>
    </select>

    <label for="color1">Color 1:</label>
    <select id="color1"></select>

    <label for="color2">Color 2:</label>
    <select id="color2"></select>

    <label for="size">Size:</label>
    <select id="size"></select>

    <p id="price">Price: --</p>
    <p id="stock">In Stock: --</p>

    <label for="quantity">Quantity:</label>
    <input type="number" id="quantity" min="1" value="1">

    <button id="orderButton">Place Order</button>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bracelets – Tactics & Treats Preorder</title>
<style>
  body { font-family: "Poppins", sans-serif; background: linear-gradient(to right, #7a0c0c, #000, #7a0c0c); color: white; margin: 0; padding: 20px; }
  nav { text-align: center; background: #111; padding: 10px 0; border-bottom: 2px solid #ff0000; box-shadow: 0 0 10px #ff0000; }
  nav a { color: white; margin: 0 15px; font-weight: bold; text-decoration: none; transition: 0.2s; }
  nav a:hover { color: #ff0000; text-shadow: 0 0 6px #ff0000; }
  h1 { text-align: center; color: #ff0000; margin-bottom: 30px; }
  form { background: #111; border-radius: 16px; padding: 20px; margin: 20px auto; max-width: 500px; box-shadow: 0 0 15px #ff0000; }
  label { display: block; margin-top: 10px; font-weight: 500; color: white; }
  input, select { width: 100%; padding: 10px; border-radius: 8px; border: none; margin-top: 5px; font-size: 14px; }
  button { margin-top: 20px; padding: 12px; border: none; background: #ff0000; color: #fff; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; transition: 0.2s; }
  button:hover { background: darkred; }
  .meet-label { display: none; color: #bbb; font-style: italic; margin-top: 10px; }
  .paypal-btn { display: inline-block; background: #ffc439; color: black; padding: 10px 20px; border-radius: 8px; font-weight: bold; text-decoration: none; margin-top: 15px; transition: 0.2s; }
  .paypal-btn:hover { background: #ffb347; }
  .paypal-container { text-align: center; margin-top: 20px; padding: 15px; background: #222; border-radius: 12px; box-shadow: 0 0 10px #ff0000; }
</style>
</head>
<body>
<nav>
  <a href="cookies.html">Cookies</a>
  <a href="bracelets.html">Bracelets</a>
  <a href="spiritwear.html">Spirit Wear</a>
</nav>

<h1>Bracelet Preorder</h1>

<form id="braceletForm">
  <label>Name</label>
  <input id="braceletName" type="text" required />

  <label>Email</label>
  <input id="braceletEmail" type="email" required />

  <label>Choose Bracelet</label>
  <select id="braceletSelect" required></select>

  <label>Color 1</label>
  <select id="color1" required></select>

  <label>Color 2</label>
  <select id="color2" required></select>

  <label>Quantity</label>
  <input id="braceletQty" type="number" min="1" required />

  <div class="checkbox-line">
    <input type="checkbox" id="braceletAtSchool" onchange="toggleAddress('bracelet')" />
    <label for="braceletAtSchool">I'm at Sandpoint High</label>
  </div>

  <div id="braceletMeetLabel" class="meet-label">Meet by coffee shop</div>

  <div id="braceletAddressField">
    <label>Address</label>
    <input id="braceletAddress" type="text" placeholder="123 Main St" />
  </div>

  <div id="braceletStateField">
    <label>State</label>
    <select id="braceletState">
      <option value="">Select a state</option>
      <option>ID</option><option>WA</option><option>MT</option><option>CA</option><option>OR</option>
    </select>
  </div>

  <button type="button" onclick="submitOrder('bracelet')">Submit Bracelet Order</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain: "bracelets-and-color.firebaseapp.com",
  projectId: "bracelets-and-color",
  storageBucket: "bracelets-and-color.firebasestorage.app",
  messagingSenderId: "382292570673",
  appId: "1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function loadBracelets() {
  const braceletSnap = await getDocs(collection(db, "products_bracelets"));
  const colorSnap = await getDocs(collection(db, "braceletColors"));
  const braceletSelect = document.getElementById("braceletSelect");
  const color1Select = document.getElementById("color1");
  const color2Select = document.getElementById("color2");

  braceletSelect.innerHTML = "";
  braceletSnap.forEach(doc => {
    const d = doc.data();
    const opt = document.createElement("option");
    opt.value = JSON.stringify(d); // store full object including paymentLink
    opt.textContent = d.stock && d.stock > 0
      ? `${d.name || d.type} - $${d.price} (${d.stock} in stock)`
      : `${d.name || d.type} - OUT OF STOCK`;
    opt.disabled = !d.stock || d.stock === 0;
    braceletSelect.appendChild(opt);
  });

  color1Select.innerHTML = '<option value="">Select Color 1</option>';
  color2Select.innerHTML = '<option value="">Select Color 2</option>';
  colorSnap.forEach(doc => {
    const color = doc.data().name;
    color1Select.innerHTML += `<option value="${color}">${color}</option>`;
    color2Select.innerHTML += `<option value="${color}">${color}</option>`;
  });
}

window.addEventListener("load", loadBracelets);

window.toggleAddress = function(prefix) {
  const atSchool = document.getElementById(`${prefix}AtSchool`).checked;
  document.getElementById(`${prefix}AddressField`).style.display = atSchool ? "none" : "block";
  document.getElementById(`${prefix}StateField`).style.display = atSchool ? "none" : "block";
  document.getElementById(`${prefix}MeetLabel`).style.display = atSchool ? "block" : "none";
};

window.submitOrder = async function(type) {
  const name = document.getElementById(`${type}Name`).value.trim();
  const email = document.getElementById(`${type}Email`).value.trim();
  const qty = Number(document.getElementById(`${type}Qty`).value);
  const product = JSON.parse(document.getElementById(`${type}Select`).value);
  const color1 = document.getElementById("color1").value;
  const color2 = document.getElementById("color2").value;
  const atSchool = document.getElementById(`${type}AtSchool`).checked;
  const address = atSchool ? "Meet by coffee shop" : document.getElementById(`${type}Address`).value.trim();
  const state = atSchool ? "" : document.getElementById(`${type}State`).value;

  if (product.stock === 0) {
    alert("Sorry, this item is out of stock.");
    return;
  }

  const total = qty * product.price;

  await addDoc(collection(db, "braceletOrders"), {
    name, email, product: product.name || product.type, qty, color1, color2,
    address, state, atSchool, total, createdAt: new Date(), status: "Pending", paymentLink: product.paymentLink || null
  });

  const oldDiv = document.querySelector(".paypal-container");
  if (oldDiv) oldDiv.remove();

  if (!product.paymentLink) {
    alert("❌ No payment link is set for this product. Contact admin.");
    return;
  }

  const payDiv = document.createElement("div");
  payDiv.className = "paypal-container";
  payDiv.innerHTML = `
    <p>Order submitted! Total: $${total.toFixed(2)}</p>
    <p>Bracelet: ${product.name || product.type} | Quantity: ${qty}</p>
    <a href="${product.paymentLink}" target="_blank" class="paypal-btn">Pay Here</a>
  `;
  document.getElementById(`${type}Form`).appendChild(payDiv);
  document.getElementById(`${type}Form`).reset();
};
</script>
</body>
</html>

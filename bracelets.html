<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Order Bracelets</title>

<style>
body {
  margin: 0;
  background: #f2f2f2;
  font-family: system-ui, sans-serif;
}

.app {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}

h2 {
  text-align: center;
}

.card {
  background: white;
  padding: 16px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,.08);
}

input, select, button {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 16px;
}

button {
  background: black;
  color: white;
  border: none;
}

.price {
  font-size: 18px;
  margin-bottom: 4px;
}

.stock {
  font-size: 13px;
  opacity: 0.7;
  margin-bottom: 10px;
}

img {
  width: 100%;
  border-radius: 10px;
  margin-bottom: 10px;
  display: none;
}
</style>
</head>

<body>
<div class="app">
  <h2>Custom Bracelets</h2>

  <div class="card">
    <input id="customerName" placeholder="Your name">

    <select id="productSelect"></select>

    <img id="preview">

    <div class="price">
      Price: $<span id="price">0.00</span>
    </div>

    <div class="stock" id="stock"></div>

    <input id="colors" placeholder="Colors (ex: red / black)">

    <select id="size">
      <option>Youth</option>
      <option>Adult</option>
    </select>

    <button onclick="placeOrder()">Place Order</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  addDoc,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE CONFIG (YOUR PROJECT) */
const firebaseConfig = {
  apiKey: "AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain: "bracelets-and-color.firebaseapp.com",
  projectId: "bracelets-and-color",
  storageBucket: "bracelets-and-color.appspot.com",
  messagingSenderId: "382292570673",
  appId: "1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ðŸ§  STATE */
let products = {};
let selectedProductId = null;

/* ðŸ“¦ LOAD PRODUCTS (LIVE FROM ADMIN) */
onSnapshot(collection(db, "products"), snap => {
  productSelect.innerHTML = "";
  products = {};
  selectedProductId = null;
  preview.style.display = "none";
  price.innerText = "0.00";
  stock.innerText = "";

  snap.forEach(d => {
    const p = d.data();

    // ONLY SHOW BRACELETS
    if (p.category !== "bracelet") return;

    // HIDE INACTIVE PRODUCTS
    if (p.active === false) return;

    // HIDE OUT OF STOCK
    if (p.stock <= 0) return;

    products[d.id] = { id: d.id, ...p };

    productSelect.innerHTML += `
      <option value="${d.id}">${p.name}</option>
    `;
  });

  if (productSelect.options.length > 0) {
    selectProduct(productSelect.value);
  } else {
    productSelect.innerHTML = `<option>No bracelets available</option>`;
  }
});

/* ðŸ” PRODUCT CHANGE */
productSelect.addEventListener("change", e => {
  selectProduct(e.target.value);
});

function selectProduct(id) {
  const p = products[id];
  if (!p) return;

  selectedProductId = id;
  price.innerText = p.price.toFixed(2);
  stock.innerText = `In stock: ${p.stock}`;
  preview.src = p.image;
  preview.style.display = "block";
}

/* ðŸ›’ PLACE ORDER */
window.placeOrder = async () => {
  if (!selectedProductId) {
    alert("No product selected");
    return;
  }

  const p = products[selectedProductId];

  if (!customerName.value) {
    alert("Please enter your name");
    return;
  }

  if (p.stock <= 0) {
    alert("Sorry, this item is out of stock");
    return;
  }

  // SAVE ORDER
  await addDoc(collection(db, "orders"), {
    category: "bracelet",
    productId: p.id,
    productName: p.name,
    price: p.price,
    image: p.image,
    name: customerName.value,
    colors: colors.value,
    size: size.value,
    status: "new",
    createdAt: Date.now()
  });

  // DECREASE STOCK
  await updateDoc(doc(db, "products", p.id), {
    stock: p.stock - 1
  });

  // CONFIRMATION
  location.href = "confirmation.html";
};
</script>
</body>
</html>

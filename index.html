<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tactics & Treats ‚Äî Admin Dashboard (Debug)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body{background:linear-gradient(90deg,#8b0000,#000);color:#fff;min-height:100vh}
    .card{background:rgba(10,10,10,0.9);border-radius:0.75rem;padding:1rem;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .muted{color:#cbd5e1}
    #status{padding:.5rem 1rem;border-radius:.5rem}
    pre#debug{white-space:pre-wrap;word-break:break-word;background:#111;padding:0.8rem;border-radius:.5rem;max-height:220px;overflow:auto}
  </style>
</head>
<body class="p-6">

  <header class="mb-6 text-center">
    <h1 class="text-3xl font-bold">üõ†Ô∏è Tactics & Treats ‚Äî Admin (Debug)</h1>
    <p class="muted">Shows clear errors so you can fix the config or file hosting quickly.</p>
  </header>

  <main class="max-w-4xl mx-auto space-y-6">

    <div class="card">
      <div class="flex items-center justify-between mb-3">
        <div>
          <strong>Status:</strong>
          <div id="status" class="inline-block ml-3 muted">Starting‚Ä¶</div>
        </div>
        <div class="space-x-2">
          <button id="openConsoleBtn" class="px-3 py-1 rounded bg-gray-700">Open Console (F12)</button>
        </div>
      </div>

      <p class="muted text-sm mb-2">If you see a message about <code>file://</code> or "Failed to resolve module specifier", read the checklist below.</p>
      <div>
        <strong>Debug info:</strong>
        <pre id="debug">Waiting...</pre>
      </div>
    </div>

    <div class="card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Collections (live)</h2>
        <div class="space-x-2">
          <button id="refreshCookies" class="px-3 py-1 rounded bg-red-700">Refresh Cookies</button>
          <button id="refreshBracelets" class="px-3 py-1 rounded bg-red-700">Refresh Bracelets</button>
          <button id="refreshOrders" class="px-3 py-1 rounded bg-red-700">Refresh Orders</button>
        </div>
      </div>

      <section class="mb-4">
        <h3 class="font-medium">üç™ Cookies</h3>
        <div id="cookiesList" class="mt-2"></div>
      </section>

      <section class="mb-4">
        <h3 class="font-medium">üßø Bracelets</h3>
        <div id="braceletList" class="mt-2"></div>
      </section>

      <section>
        <h3 class="font-medium">üì¶ Orders</h3>
        <div id="orderList" class="mt-2"></div>
      </section>
    </div>

    <div class="card">
      <h3 class="font-semibold mb-2">Quick Checklist / Common fixes</h3>
      <ul class="muted list-disc ml-5">
        <li>Are you opening this page with <code>file://</code>? ES modules require a server. Run <code>python -m http.server</code> or <code>npx http-server</code> or use VSCode Live Server.</li>
        <li>Is the path to <code>firebase-config.js</code> correct? Edit <code>FIREBASE_CONFIG_PATH</code> at the top of the script.</li>
        <li>Does <code>firebase-config.js</code> export <code>export const db = getFirestore(app);</code> (example below)?</li>
        <li>Are your Firestore collections named exactly <strong>cookies</strong>, <strong>bracelets</strong>, and <strong>orders</strong>? (case-sensitive)</li>
        <li>Check the browser console (F12 ‚Üí Console) for full stack traces ‚Äî copy/paste here if still stuck.</li>
      </ul>
    </div>

  </main>

  <script type="module">
    // ---------- CONFIG ----------
    const FIREBASE_CONFIG_PATH = "../firebase/firebase-config.js"; // <<--- edit if needed
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ---------- UI refs ----------
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");
    const cookiesList = document.getElementById("cookiesList");
    const braceletList = document.getElementById("braceletList");
    const orderList = document.getElementById("orderList");

    function setStatus(msg, isError = false){
      statusEl.textContent = msg;
      statusEl.style.color = isError ? "#ffb4b4" : "#d1fae5";
      console.log(msg);
    }
    function setDebug(msg){
      debugEl.textContent = String(msg || "");
      console.log(msg);
    }

    document.getElementById("openConsoleBtn").addEventListener("click", ()=> {
      alert("Open DevTools: F12 (or right-click ‚Üí Inspect) and check the Console tab. Then paste errors here if needed.");
    });

    // If running from file:// show warning and stop
    if (location.protocol === "file:") {
      setStatus("‚ùå Page loaded via file:// ‚Äî start a local server (see checklist).", true);
      setDebug("Detected file:// protocol ‚Äî ES modules won't import external modules when loaded via the file system.\nRun in a local server (e.g. python -m http.server) and reload.");
      throw new Error("Loaded via file://; aborting.");
    }

    // ---------- dynamic import of firebase-config.js ----------
    let db;
    (async () => {
      setStatus("Loading firebase-config...");
      try {
        const mod = await import(FIREBASE_CONFIG_PATH);
        db = mod.db;
        if (!db) throw new Error('firebase-config.js did not export "db" (export const db = ...).');
        setStatus("‚úÖ Firebase config loaded.");
        setDebug("Firebase config loaded from: " + FIREBASE_CONFIG_PATH);
      } catch (err) {
        setStatus("‚ùå Failed to load firebase-config.", true);
        setDebug(err.stack || err.message || String(err));
        // Stop here ‚Äî we cannot call Firestore without db
        return;
      }

      // wire refresh buttons
      document.getElementById("refreshCookies").onclick = () => loadCollection("cookies", cookiesList);
      document.getElementById("refreshBracelets").onclick = () => loadCollection("bracelets", braceletList);
      document.getElementById("refreshOrders").onclick = () => loadCollection("orders", orderList);

      // initial loads (catch errors individually)
      await Promise.allSettled([
        loadCollection("cookies", cookiesList),
        loadCollection("bracelets", braceletList),
        loadCollection("orders", orderList)
      ]).then(results => {
        setStatus("‚úÖ Initial load finished. Check lists above and the debug box for details.");
      });
    })();

    // ---------- loader helper ----------
    async function loadCollection(name, containerEl){
      containerEl.innerHTML = '<p class="muted">Loading...</p>';
      try {
        const snap = await getDocs(collection(db, name));
        containerEl.innerHTML = "";
        if (snap.empty) {
          containerEl.innerHTML = `<p class="muted">No documents found in "${name}".</p>`;
          return;
        }
        snap.forEach(doc => {
          const data = doc.data();
          // build field list (show everything)
          let fields = "";
          for (let k in data) {
            fields += `<p class="text-sm"><span class="muted text-xs">${k}:</span> ${escapeHtml(String(data[k]))}</p>`;
          }
          const card = document.createElement("div");
          card.className = "p-3 bg-gray-900 rounded mb-2";
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:600">${escapeHtml(data.name || data.type || "Item")}</div>
                ${fields}
                <div class="muted text-xs">Doc ID: ${doc.id}</div>
              </div>
              <div style="text-align:right">
                <div style="font-weight:700">$${escapeHtml(String(data.price ?? ""))}</div>
                <div class="muted text-xs">${escapeHtml(String(data.stockQty ?? data.stock ?? ""))} in stock</div>
              </div>
            </div>
          `;
          containerEl.appendChild(card);
        });
      } catch (err) {
        containerEl.innerHTML = `<p style="color:salmon">Error reading "${name}": ${escapeHtml(err.message || err)}</p>`;
        setDebug((debugEl.textContent || "") + `\nError loading ${name}: ${err.stack || err.message || err}`);
        console.error(err);
      }
    }

    function escapeHtml(s){
      return String(s||"").replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
  </script>
</body>
</html>

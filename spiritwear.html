<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spirit Wear Preorder – Tactics & Treats</title>

<!-- Tailwind v3 -->
<script src="https://cdn.tailwindcss.com/3.4.14"></script>

<style>
body {
  background: linear-gradient(135deg, #1a0000, #330000);
  color: white;
  font-family: 'Poppins', sans-serif;
  min-height: 100vh;
  padding: 2rem;
}
.card {
  background: rgba(0, 0, 0, 0.6);
  border-radius: 1rem;
  padding: 1.5rem;
  margin-top: 2rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}
button {
  background: linear-gradient(90deg, #b00, #e00);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  font-weight: 600;
  transition: all 0.3s;
}
button:hover {
  background: linear-gradient(90deg, #e00, #ff3333);
  transform: translateY(-1px);
}
select, input {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: white;
  padding: 8px;
  width: 100%;
}
select option {
  color: black;
}
nav a {
  color: #ff9999;
  margin: 0 10px;
  font-weight: 600;
  transition: color 0.2s;
}
nav a:hover {
  color: white;
  text-decoration: underline;
}
</style>
</head>

<body class="flex flex-col items-center">
  <nav class="mb-6">
    <a href="cookies.html">Cookies</a> |
    <a href="bracelets.html">Bracelets</a> |
    <a href="spiritwear.html" class="text-white underline">Spirit Wear</a> |
  
  </nav>

  <h1 class="text-3xl font-bold mb-4 text-red-200">Spirit Wear Preorder</h1>

  <div class="card w-full max-w-lg">
    <form id="orderForm" class="space-y-4">
      <div>
        <label for="name" class="block mb-1 font-semibold">Name</label>
        <input id="name" name="name" type="text" required />
      </div>

      <div>
        <label for="email" class="block mb-1 font-semibold">Email</label>
        <input id="email" name="email" type="email" required />
      </div>

      <div>
        <label for="productSelect" class="block mb-1 font-semibold">Choose Item</label>
        <select id="productSelect" name="product" required>
          <option value="">Loading...</option>
        </select>
      </div>

      <div>
        <label for="sizeSelect" class="block mb-1 font-semibold">Choose Size</label>
        <select id="sizeSelect" name="size" required>
          <option value="">Select Size</option>
          <option value="S">Small</option>
          <option value="M">Medium</option>
          <option value="L">Large</option>
          <option value="XL">X-Large</option>
          <option value="2XL">2X-Large</option>
        </select>
      </div>

      <div>
        <label for="quantity" class="block mb-1 font-semibold">Quantity</label>
        <input id="quantity" name="quantity" type="number" min="1" value="1" />
      </div>

      <div aria-live="polite">
        <p id="priceDisplay" class="text-lg mt-2 text-red-300">Price: $0.00</p>
        <p id="totalDisplay" class="text-lg mt-1 text-green-300">Total: $0.00</p>
      </div>

      <button type="submit" class="w-full mt-2">Submit Preorder</button>
    </form>

    <p id="message" class="text-center mt-4 text-yellow-300 hidden"></p>
  </div>

<!-- ================= FIREBASE SCRIPT ================= -->
<script type="module">
import { 
  initializeApp 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getFirestore, collection, getDocs, addDoc, runTransaction, doc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ✅ Correct Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain: "bracelets-and-color.firebaseapp.com",
  projectId: "bracelets-and-color",
  storageBucket: "bracelets-and-color.appspot.com",
  messagingSenderId: "382292570673",
  appId: "1:382292570673:web:1c966e2e7e8fc2efa31b10",
  measurementId: "G-BJPQN6S7YB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ✅ Fixed collection names
const productsCol = collection(db, "products_spirit");
const ordersCol = collection(db, "spiritOrders");

// Elements
const select = document.getElementById("productSelect");
const priceDisplay = document.getElementById("priceDisplay");
const totalDisplay = document.getElementById("totalDisplay");
const quantityInput = document.getElementById("quantity");
const message = document.getElementById("message");

let products = {};
let currentPrice = 0;

// ================== Load products ==================
async function loadProducts() {
  try {
    const snapshot = await getDocs(productsCol);
    select.innerHTML = `<option value="">Choose Item</option>`;
    products = {};

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      products[docSnap.id] = data;

      const option = document.createElement("option");
      option.value = docSnap.id;

      const stockText = data.stock <= 0
        ? " (Out of Stock)"
        : ` (${data.stock} in stock)`;
      option.textContent = `${data.name || "Unnamed"} - $${(data.price ?? 0).toFixed(2)}${stockText}`;
      if (data.stock <= 0) option.disabled = true;
      select.appendChild(option);
    });
  } catch (err) {
    console.error(err);
    message.textContent = "⚠️ Error loading products. Please try again.";
    message.classList.remove("hidden");
  }
}
await loadProducts();

// ================== Update totals ==================
select.addEventListener("change", () => {
  const selected = products[select.value];
  currentPrice = selected ? Number(selected.price) || 0 : 0;
  updateTotals();
});

quantityInput.addEventListener("input", updateTotals);

function updateTotals() {
  const qty = parseInt(quantityInput.value) || 1;
  const total = qty * currentPrice;
  priceDisplay.textContent = `Price: $${currentPrice.toFixed(2)}`;
  totalDisplay.textContent = `Total: $${total.toFixed(2)}`;
}

// ================== Handle submit ==================
document.getElementById("orderForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  message.classList.add("hidden");

  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const productId = select.value;
  const size = document.getElementById("sizeSelect").value;
  const quantity = parseInt(quantityInput.value) || 1;

  if (!name || !email || !productId || !size) {
    alert("⚠️ Please fill out all fields.");
    return;
  }

  try {
    await runTransaction(db, async (transaction) => {
      const productRef = doc(db, "products_spirit", productId);
      const productSnap = await transaction.get(productRef);

      if (!productSnap.exists()) throw new Error("Product not found");
      const data = productSnap.data();
      if (data.stock < quantity) throw new Error("Not enough stock available.");

      const total = quantity * (data.price || 0);
      transaction.update(productRef, { stock: data.stock - quantity });

      await addDoc(ordersCol, {
        name, email, size,
        product: data.name,
        sku: data.sku || "",
        quantity,
        total,
        timestamp: serverTimestamp(),
        status: "Pending"
      });
    });

    message.textContent = "✅ Order placed successfully!";
    message.classList.remove("hidden");
    document.getElementById("orderForm").reset();
    updateTotals();
    await loadProducts();

  } catch (error) {
    console.error(error);
    alert("❌ " + error.message);
  }
});
</script>

</body>
</html>
